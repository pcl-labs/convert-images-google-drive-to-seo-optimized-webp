# Cloudflare Workers configuration
#
# This file configures the Quill API Worker for Cloudflare's Python Workers runtime.
# The Worker entrypoint is src/workers/main.py, which uses FastAPI via an ASGI adapter.
#
# For local development, use: python run_api.py (or uvicorn)
# For Worker dev/preview: wrangler dev
# For Worker production: wrangler deploy
#
# See docs/CLOUDFLARE_WORKERS.md for detailed setup instructions.

name = "quill-api"
main = "src/workers/main.py"  # Python Worker entrypoint (Default class)
compatibility_date = "2024-01-01"
compatibility_flags = ["python_workers"]  # Required for Python Workers

# Environment variables (accessible via os.environ in Worker)
# These are set at deploy time and can be overridden per-environment
[vars]
ENVIRONMENT = "production"  # Used by Settings.environment
DEBUG = "false"             # Used by Settings.debug

# D1 Database binding
# The binding name "DB" must match what the code expects (see src/workers/runtime.py)
# Code accesses this via env.DB, which is mapped to settings.d1_database
[[d1_databases]]
binding = "DB"  # Must match WORKER_DB_BINDING in src/workers/runtime.py
database_name = "quill-db"
database_id = "933d76cf-a988-4a71-acc6-d884278c6402"  # Get via: wrangler d1 list

# Queue bindings for background job processing
# Code expects JOB_QUEUE and DLQ bindings (see src/workers/runtime.py)
[[queues.producers]]
queue = "quill-jobs"  # Primary job queue name
binding = "JOB_QUEUE"  # Must match WORKER_QUEUE_BINDING in src/workers/runtime.py

[[queues.consumers]]
queue = "quill-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "quill-dlq"

# Dead letter queue (for failed jobs after max retries)
[[queues.producers]]
queue = "quill-dlq"  # Dead letter queue name
binding = "DLQ"  # Must match WORKER_DLQ_BINDING in src/workers/runtime.py

# Required Secrets (set via: wrangler secret put SECRET_NAME)
# These are encrypted and accessible via os.environ in the Worker
#
# Required for authentication:
#   wrangler secret put JWT_SECRET_KEY          # Secret key for JWT tokens (required)
#   wrangler secret put GITHUB_CLIENT_ID        # GitHub OAuth Client ID
#   wrangler secret put GITHUB_CLIENT_SECRET    # GitHub OAuth Client Secret
#   wrangler secret put GOOGLE_CLIENT_ID        # Google OAuth Client ID (for Drive/YouTube)
#   wrangler secret put GOOGLE_CLIENT_SECRET    # Google OAuth Client Secret
#
# Optional:
#   wrangler secret put GITHUB_REDIRECT_URI     # OAuth redirect URI (optional)
#   wrangler secret put BASE_URL                 # Base URL for the app (optional)
#   wrangler secret put OPENAI_API_KEY          # OpenAI API key (optional, for AI features)
#
# For production with Cloudflare Queues (USE_INLINE_QUEUE=false):
#   wrangler secret put CLOUDFLARE_ACCOUNT_ID   # Cloudflare account ID
#   wrangler secret put CLOUDFLARE_API_TOKEN    # API token with Queues:Edit permission
#   wrangler secret put CF_QUEUE_NAME           # Queue name (default: "quill-jobs")
#   wrangler secret put CF_QUEUE_DLQ            # DLQ name (default: "quill-dlq")
#
# See docs/CLOUDFLARE_WORKERS.md for complete setup instructions.

# Routes (optional - for custom domain)
# Uncomment and configure if you want to use a custom domain:
# routes = [
#   { pattern = "api.example.com/*", zone_name = "example.com" }
# ]

# Resource Limits
[limits]
cpu_ms = 50000  # 50 seconds CPU time per request (default: 50s, max: 50s)

# Observability / Logging
[observability]
enabled = false
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true  # Logs each request invocation

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1