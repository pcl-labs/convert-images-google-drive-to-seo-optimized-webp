# Cloudflare Workers configuration
#
# This file configures the Quill API Worker for Cloudflare's Python Workers runtime.
# The Worker entrypoint is src/workers/main.py, which uses FastAPI via an ASGI adapter.
#
# For local development, use: python run_api.py (or uvicorn)
# For Worker dev/preview: wrangler dev
# For Worker production: wrangler deploy
#
# See docs/CLOUDFLARE_WORKERS.md for detailed setup instructions.

name = "quill-api"
main = "src/workers/main.py"  # Python Worker entrypoint (Default class)
compatibility_date = "2024-01-01"
compatibility_flags = ["python_workers"]  # Required for Python Workers

# Environment variables (accessible via os.environ in Worker)
# These are set at deploy time and can be overridden per-environment
[vars]
ENVIRONMENT = "production"  # Used by Settings.environment
DEBUG = "false"             # Used by Settings.debug
BASE_URL = "https://quill-api.paulchrisluke.workers.dev"  # OAuth redirect URI base for Cloudflare Workers
STATIC_FILES_DIR = "./static"
CORS_ORIGINS = "http://localhost:8000,http://127.0.0.1:8000,http://localhost:8787,http://127.0.0.1:8787,https://quill-api.paulchrisluke.workers.dev"
JWT_USE_COOKIES = "true"
QUEUE_NAME = "quill-jobs"
DEAD_LETTER_QUEUE_NAME = "quill-dlq"
USE_INLINE_QUEUE = "false"  # Ignored at runtime; environment controls inline vs queue
TRANSCRIPT_LANGS = "en,en-US,en-GB"
OPENAI_API_BASE = "https://gateway.ai.cloudflare.com/v1/fa3dc6c06433f6b0ea78d95bce23ad91/quill/compat"
# YouTube transcript proxy service (tubularblogs.com)
# Set via: wrangler secret put YOUTUBE_PROXY_API_URL
# Set via: wrangler secret put YOUTUBE_PROXY_API_KEY

# D1 Database binding
# The binding name "DB" must match what the code expects (see src/workers/runtime.py)
# Code accesses this via env.DB, which is mapped to settings.d1_database
[[d1_databases]]
binding = "DB"  # Must match WORKER_DB_BINDING in src/workers/runtime.py
database_name = "quill-db"
database_id = "933d76cf-a988-4a71-acc6-d884278c6402"  # Get via: wrangler d1 list

# Queue bindings for background job processing
# Code expects JOB_QUEUE and DLQ bindings (see src/workers/runtime.py)
[[queues.producers]]
queue = "quill-jobs"  # Primary job queue name
binding = "JOB_QUEUE"  # Must match WORKER_QUEUE_BINDING in src/workers/runtime.py

[[queues.consumers]]
queue = "quill-jobs"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "quill-dlq"

# Dead letter queue (for failed jobs after max retries)
[[queues.producers]]
queue = "quill-dlq"  # Dead letter queue name
binding = "DLQ"  # Must match WORKER_DLQ_BINDING in src/workers/runtime.py

# Required Secrets (set via: wrangler secret put SECRET_NAME)
# These are encrypted and accessible via os.environ in the Worker
#
# Required for authentication:
#   wrangler secret put JWT_SECRET_KEY          # Secret key for JWT tokens (required)
#   wrangler secret put GITHUB_CLIENT_ID        # GitHub OAuth Client ID
#   wrangler secret put GITHUB_CLIENT_SECRET    # GitHub OAuth Client Secret
#   wrangler secret put GOOGLE_CLIENT_ID        # Google OAuth Client ID (for Drive/YouTube)
#   wrangler secret put GOOGLE_CLIENT_SECRET    # Google OAuth Client Secret
#
# Optional:
#   wrangler secret put GITHUB_REDIRECT_URI     # OAuth redirect URI (optional)
#   wrangler secret put BASE_URL                 # Base URL for the app (optional)
#   wrangler secret put OPENAI_API_KEY          # OpenAI API key (optional, for lean gateway)
#   wrangler secret put YOUTUBE_PROXY_API_URL   # YouTube proxy service URL (e.g., https://tubularblogs.com)
#   wrangler secret put YOUTUBE_PROXY_API_KEY   # YouTube proxy service API key
#
# For production with Cloudflare Queues (USE_INLINE_QUEUE=false):
#   wrangler secret put CLOUDFLARE_ACCOUNT_ID   # Cloudflare account ID (required for Queues and Vectorize)
#   wrangler secret put CLOUDFLARE_API_TOKEN    # API token with Queues Read/Edit AND Vectorize Read/Edit permissions
#                                                # This token is used for both Queue operations and Vectorize embeddings
#   wrangler secret put CF_QUEUE_NAME           # Queue name (default: "quill-jobs")
#   wrangler secret put CF_QUEUE_DLQ            # DLQ name (default: "quill-dlq")
#
# Note: CLOUDFLARE_API_TOKEN permissions depend on features used.
# Create token in Cloudflare Dashboard → My Profile → API Tokens with:
#   - Queues Read
#   - Queues Edit
#   - Restricted to account: fa3dc6c06433f6b0ea78d95bce23ad91
#
# See docs/CLOUDFLARE_WORKERS.md for complete setup instructions.

# Static assets binding
# This tells Wrangler to bundle all files from src/workers/static
# and make them accessible via env.ASSETS.fetch() in the Worker
[assets]
directory = "src/workers/static"
binding = "ASSETS"

# Routes (optional - for custom domain)
# Uncomment and configure if you want to use a custom domain:
# routes = [
#   { pattern = "api.example.com/*", zone_name = "example.com" }
# ]

# Resource Limits
[limits]
cpu_ms = 50000  # 50 seconds CPU time per request (default: 50s, max: 50s)

# Observability / Logging
[observability]
enabled = false
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
persist = true
invocation_logs = true  # Logs each request invocation

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

# Local development overrides for `wrangler dev` and `wrangler deploy --env local`
[env.local.vars]
ENVIRONMENT = "development"
DEBUG = "true"
BASE_URL = "http://localhost:8787"
# Inline vs queue is derived from ENVIRONMENT by Settings; no need to
# override USE_INLINE_QUEUE here.
CORS_ORIGINS = "http://localhost:8000,http://127.0.0.1:8000,http://localhost:8787,http://127.0.0.1:8787"