{% extends "base.html" %}
{% from 'components/elements/input.html' import input %}
{% from 'components/elements/button.html' import button %}
{% from 'components/layout/page.html' import page_container, page_header %}
{% block content %}
{% call page_container() %}
  {% set header_actions %}
    <div class="text-sm text-content break-all">
      <div class="text-xs uppercase tracking-wide text-contentMuted">Origin</div>
      <div>{{ document.origin or 'None' }}</div>
    </div>
  {% endset %}
  {{ page_header('Document ' ~ document.id, 'Source: ' ~ document.source_label ~ ' • Created ' ~ (document.created_at or 'unknown'), actions=header_actions) }}
  <p class="text-sm text-primary"><a href="/dashboard/documents" class="hover:text-primary/80">&larr; Back to Documents</a></p>

  <div id="doc-flash" class="space-y-2"></div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% from 'components/elements/card.html' import card %}
    {% call card(title='Metadata') %}
      {% if metadata_items %}
        <dl class="space-y-2 text-sm">
          {% for key, value in metadata_items %}
            <div class="flex flex-col">
              <dt class="text-contentMuted uppercase text-xs tracking-wide">{{ key }}</dt>
              <dd class="text-content break-words">{{ value }}</dd>
            </div>
          {% endfor %}
        </dl>
      {% else %}
        <p class="text-sm text-contentMuted">No metadata recorded.</p>
      {% endif %}
    {% endcall %}
    {% call card(title='Frontmatter') %}
      {% if frontmatter_items %}
        <dl class="space-y-2 text-sm">
          {% for key, value in frontmatter_items %}
            <div class="flex flex-col">
              <dt class="text-contentMuted uppercase text-xs tracking-wide">{{ key }}</dt>
              <dd class="text-content break-words">{{ value }}</dd>
            </div>
          {% endfor %}
        </dl>
      {% else %}
        <p class="text-sm text-contentMuted">No frontmatter recorded yet.</p>
      {% endif %}
    {% endcall %}
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    {% call card(title='Generate Blog Draft') %}
      <form class="space-y-3" hx-post="/dashboard/documents/{{ document.id }}/generate" hx-target="#doc-flash" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {{ input('tone', label='Tone', value='informative') }}
        <div class="grid grid-cols-2 gap-2">
          {{ input('max_sections', label='Max Sections', type='number', value='5', attrs='min="1" max="12"') }}
          {{ input('target_chapters', label='Target Chapters', type='number', value='4', attrs='min="1" max="12"') }}
        </div>
        <label class="inline-flex items-center gap-2 text-sm text-content">
          <input type="checkbox" name="include_images" checked class="rounded border-border bg-card text-primary focus:ring-primary">
          Include image prompts
        </label>
        {{ button('Queue Generation', variant='primary', attrs='type="submit" class="w-full"') }}
      </form>
    {% endcall %}
    {% call card(title='Latest Draft Summary') %}
      {% if latest_version %}
        <dl class="space-y-2 text-sm">
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Version</dt>
            <dd class="text-content">v{{ latest_version.version }} &middot; {{ latest_version.created_at }}</dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Title</dt>
            <dd class="text-content">{{ latest_version.title or 'Untitled Draft' }}</dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Slug</dt>
            <dd class="text-content">{{ latest_version.frontmatter.slug or '—' }}</dd>
          </div>
        </dl>
        <div class="mt-4 flex flex-wrap gap-2">
          {{ button('Copy MDX', variant='ghost', attrs='type="button" onclick="copyVersionContent(\'mdx-body\')"', extra_classes='text-sm px-3 py-1.5') }}
          {{ button('Copy HTML', variant='ghost', attrs='type="button" onclick="copyVersionContent(\'html-body\')"', extra_classes='text-sm px-3 py-1.5') }}
          <a href="/dashboard/documents/{{ document.id }}/versions/{{ latest_version.version_id }}/download?format=mdx" class="text-sm px-3 py-1.5 rounded-md bg-card border border-border hover:bg-surface/60">Download MDX</a>
        </div>
      {% else %}
        <p class="text-sm text-contentMuted">No blog draft generated yet. Kick off the pipeline to create the first version.</p>
      {% endif %}
    {% endcall %}
    {% call card(title='Exports & Integrations') %}
      {% set version_selectable = latest_version is not none %}
      <form class="space-y-2" hx-post="/dashboard/documents/{{ document.id }}/exports/google_docs" hx-target="#doc-flash" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="version_id" value="{{ latest_version.version_id if latest_version }}">
        {{ button('Send to Google Docs', variant='secondary', attrs='type="submit" class="w-full"' + (' disabled' if not version_selectable else '')) }}
      </form>
      <form class="space-y-2" hx-post="/dashboard/documents/{{ document.id }}/exports/zapier" hx-target="#doc-flash" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="version_id" value="{{ latest_version.version_id if latest_version }}">
        {{ button('Send via Zapier', variant='secondary', attrs='type="submit" class="w-full"' + (' disabled' if not version_selectable else '')) }}
      </form>
      <form class="space-y-2" hx-post="/dashboard/documents/{{ document.id }}/exports/wordpress" hx-target="#doc-flash" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="version_id" value="{{ latest_version.version_id if latest_version }}">
        {{ button('Queue WordPress Export', variant='secondary', attrs='type="submit" class="w-full"' + (' disabled' if not version_selectable else '')) }}
      </form>
    {% endcall %}
  </div>

  {% call card(title='Draft Preview') %}
    {% include "documents/partials/version_viewer.html" %}
  {% endcall %}

  {% call card(title='Versions', actions='') %}
    <div class="space-y-3">
      {% for version in versions %}
        <article class="surface rounded-lg p-4 space-y-3">
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
              <p class="text-sm font-semibold text-content">v{{ version.version }} &middot; {{ version.title or 'Untitled' }}</p>
              <p class="text-xs text-contentMuted">{{ version.created_at }}</p>
            </div>
            <div class="flex flex-col gap-2 text-sm sm:flex-row sm:items-center">
              <a class="text-primary hover:text-primary/80" hx-get="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}" hx-target="#version-viewer" hx-swap="outerHTML" href="#">View</a>
              <a href="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}/download?format=mdx" class="text-contentMuted hover:text-content">Download MDX</a>
              <a href="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}/download?format=html" class="text-contentMuted hover:text-content">Download HTML</a>
            </div>
          </div>
        </article>
      {% else %}
        <div class="rounded-lg border border-border p-6 text-center text-sm text-contentMuted">No versions yet.</div>
      {% endfor %}
    </div>
  {% endcall %}

  {% call card(title='Jobs using this document', actions='<a href="/dashboard/jobs" class="text-sm text-primary hover:text-primary/80">View all jobs</a>') %}
    <div class="space-y-3">
      {% from 'components/elements/badge.html' import badge %}
      {% for job in jobs %}
        <article class="surface rounded-lg p-4 space-y-3">
          <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div class="space-y-1">
              <p class="font-mono text-xs text-contentMuted break-all">{{ job.id }}</p>
              <p class="text-sm text-content">{{ job.kind }}</p>
              <p class="text-xs text-contentMuted">Created {{ job.created_at }}</p>
            </div>
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
              {{ badge(job.status_label, status=job.status) }}
              <a href="/dashboard/jobs/{{ job.id }}" class="text-sm text-primary hover:text-primary/80">View</a>
            </div>
          </div>
        </article>
      {% else %}
        <div class="rounded-lg border border-border p-6 text-center text-sm text-contentMuted">No jobs reference this document yet.</div>
      {% endfor %}
    </div>
  {% endcall %}
{% endcall %}
{% endblock %}

{% block extra_scripts %}
<script>
  function copyVersionContent(targetId) {
    const el = document.getElementById(targetId);
    if (!el) return;
    const text = el.tagName === 'TEXTAREA' ? el.value : el.textContent;
    navigator.clipboard.writeText(text).catch(() => {});
  }
  function switchVersionTab(tabKey) {
    const tabs = ['outline', 'mdx', 'html'];
    tabs.forEach((key) => {
      const btn = document.querySelector(`[data-version-tab="${key}"]`);
      const panel = document.querySelector(`[data-version-panel="${key}"]`);
      const isActive = key === tabKey;
      
      if (btn) {
        btn.setAttribute('aria-selected', isActive);
        btn.setAttribute('tabindex', isActive ? '0' : '-1');
        btn.classList.toggle('bg-surface', isActive);
      }
      
      if (panel) {
        panel.classList.toggle('hidden', !isActive);
      }
    });
  }
  
  function handleVersionTabKeydown(event, currentTab) {
    const tabs = ['outline', 'mdx', 'html'];
    const currentIndex = tabs.indexOf(currentTab);
    let targetIndex = currentIndex;
    
    switch (event.key) {
      case 'ArrowLeft':
        event.preventDefault();
        targetIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
        break;
      case 'ArrowRight':
        event.preventDefault();
        targetIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
        break;
      case 'Home':
        event.preventDefault();
        targetIndex = 0;
        break;
      case 'End':
        event.preventDefault();
        targetIndex = tabs.length - 1;
        break;
      default:
        return; // Let other keys work normally
    }
    
    const targetTab = tabs[targetIndex];
    switchVersionTab(targetTab);
    const targetButton = document.querySelector(`[data-version-tab="${targetTab}"]`);
    if (targetButton) {
      targetButton.focus();
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    switchVersionTab('outline');
  });
</script>
{% endblock %}
