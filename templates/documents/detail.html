{% extends "base.html" %}
{% from 'components/elements/input.html' import input %}
{% from 'components/elements/button.html' import button %}
{% block content %}
<div class="p-4 md:p-6 space-y-6">
  <div class="flex items-center justify-between">
    <div>
      <p class="text-sm text-contentMuted"><a href="/dashboard/documents" class="text-primary hover:text-primary/80">&larr; Documents</a></p>
      <h1 class="text-xl font-semibold text-content mt-1 break-all">Document {{ document.id }}</h1>
      <p class="text-sm text-contentMuted">Source: {{ document.source_label }} • Created {{ document.created_at or 'unknown' }}</p>
    </div>
    <div class="text-right">
      <div class="text-xs uppercase text-contentMuted">Origin</div>
      <div class="text-sm text-content break-all max-w-xs md:max-w-md">{{ document.origin or 'None' }}</div>
    </div>
  </div>

  <div id="doc-flash" class="space-y-2"></div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    {% from 'components/elements/card.html' import card %}
    {% call card(title='Metadata') %}
      {% if metadata_items %}
        <dl class="space-y-2 text-sm">
          {% for key, value in metadata_items %}
            <div class="flex flex-col">
              <dt class="text-contentMuted uppercase text-xs tracking-wide">{{ key }}</dt>
              <dd class="text-content break-words">{{ value }}</dd>
            </div>
          {% endfor %}
        </dl>
      {% else %}
        <p class="text-sm text-contentMuted">No metadata recorded.</p>
      {% endif %}
    {% endcall %}
    {% call card(title='Frontmatter') %}
      {% if frontmatter_items %}
        <dl class="space-y-2 text-sm">
          {% for key, value in frontmatter_items %}
            <div class="flex flex-col">
              <dt class="text-contentMuted uppercase text-xs tracking-wide">{{ key }}</dt>
              <dd class="text-content break-words">{{ value }}</dd>
            </div>
          {% endfor %}
        </dl>
      {% else %}
        <p class="text-sm text-contentMuted">No frontmatter recorded yet.</p>
      {% endif %}
    {% endcall %}
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    {% call card(title='Generate Blog Draft') %}
      <form class="space-y-3" hx-post="/dashboard/documents/{{ document.id }}/generate" hx-target="#doc-flash" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        {{ input('tone', label='Tone', value='informative') }}
        <div class="grid grid-cols-2 gap-2">
          {{ input('max_sections', label='Max Sections', type='number', value='5', attrs='min="1" max="12"') }}
          {{ input('target_chapters', label='Target Chapters', type='number', value='4', attrs='min="1" max="12"') }}
        </div>
        <label class="inline-flex items-center gap-2 text-sm text-content">
          <input type="checkbox" name="include_images" checked class="rounded border-border bg-card text-primary focus:ring-primary">
          Include image prompts
        </label>
        {{ button('Queue Generation', variant='primary', attrs='type="submit" class="w-full"') }}
      </form>
    {% endcall %}
    {% call card(title='Latest Draft Summary') %}
      {% if latest_version %}
        <dl class="space-y-2 text-sm">
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Version</dt>
            <dd class="text-content">v{{ latest_version.version }} &middot; {{ latest_version.created_at }}</dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Title</dt>
            <dd class="text-content">{{ latest_version.title or 'Untitled Draft' }}</dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Slug</dt>
            <dd class="text-content">{{ latest_version.frontmatter.slug or '—' }}</dd>
          </div>
        </dl>
        <div class="mt-4 flex flex-wrap gap-2">
          {{ button('Copy MDX', variant='ghost', attrs='type="button" onclick="copyVersionContent(\'mdx-body\')"', extra_classes='text-sm px-3 py-1.5') }}
          {{ button('Copy HTML', variant='ghost', attrs='type="button" onclick="copyVersionContent(\'html-body\')"', extra_classes='text-sm px-3 py-1.5') }}
          <a href="/dashboard/documents/{{ document.id }}/versions/{{ latest_version.version_id }}/download?format=mdx" class="text-sm px-3 py-1.5 rounded-md bg-card border border-border hover:bg-surface/60">Download MDX</a>
        </div>
      {% else %}
        <p class="text-sm text-contentMuted">No blog draft generated yet. Kick off the pipeline to create the first version.</p>
      {% endif %}
    {% endcall %}
    {% call card(title='Exports & Integrations') %}
      {% set version_selectable = latest_version is not none %}
      <form class="space-y-2" hx-post="/dashboard/documents/{{ document.id }}/exports/google_docs" hx-target="#doc-flash" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="version_id" value="{{ latest_version.version_id if latest_version }}">
        {{ button('Send to Google Docs', variant='secondary', attrs='type="submit" class="w-full"' + (' disabled' if not version_selectable else '')) }}
      </form>
      <form class="space-y-2" hx-post="/dashboard/documents/{{ document.id }}/exports/zapier" hx-target="#doc-flash" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="version_id" value="{{ latest_version.version_id if latest_version }}">
        {{ button('Send via Zapier', variant='secondary', attrs='type="submit" class="w-full"' + (' disabled' if not version_selectable else '')) }}
      </form>
      <form class="space-y-2" hx-post="/dashboard/documents/{{ document.id }}/exports/wordpress" hx-target="#doc-flash" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="version_id" value="{{ latest_version.version_id if latest_version }}">
        {{ button('Queue WordPress Export', variant='secondary', attrs='type="submit" class="w-full"' + (' disabled' if not version_selectable else '')) }}
      </form>
    {% endcall %}
  </div>

  {% call card(title='Draft Preview') %}
    {% include "documents/partials/version_viewer.html" %}
  {% endcall %}

  {% call card(title='Versions', actions='') %}
    <div class="p-0 overflow-x-auto">
      {% from 'components/data/table.html' import table with context %}
      {% call table(headers=["Version","Title","Created","Actions"]) %}
        {% for version in versions %}
          <tr>
            <td class="px-3 py-2 md:px-4 md:py-3">v{{ version.version }}</td>
            <td class="px-3 py-2 md:px-4 md:py-3">{{ version.title or 'Untitled' }}</td>
            <td class="px-3 py-2 md:px-4 md:py-3 text-contentMuted">{{ version.created_at }}</td>
            <td class="px-3 py-2 md:px-4 md:py-3 space-x-2">
              <a class="text-primary text-sm hover:text-primary/80" hx-get="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}" hx-target="#version-viewer" hx-swap="outerHTML" href="#">View</a>
              <a href="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}/download?format=mdx" class="text-sm text-contentMuted hover:text-content">MDX</a>
              <a href="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}/download?format=html" class="text-sm text-contentMuted hover:text-content">HTML</a>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="4" class="px-4 py-6 text-center text-contentMuted">No versions yet.</td>
          </tr>
        {% endfor %}
      {% endcall %}
    </div>
  {% endcall %}

  {% call card(title='Jobs using this document', actions='<a href="/dashboard/jobs" class="text-sm text-primary hover:text-primary/80">View all jobs</a>') %}
    <div class="p-0 overflow-x-auto">
      {% from 'components/data/table.html' import table with context %}
      {% from 'components/elements/badge.html' import badge %}
      {% call table(headers=["Job ID","Type","Status","Created","View"]) %}
        {% for job in jobs %}
          <tr>
            <td class="px-3 py-2 md:px-4 md:py-3 whitespace-nowrap">{{ job.id }}</td>
            <td class="px-3 py-2 md:px-4 md:py-3">{{ job.kind }}</td>
            <td class="px-3 py-2 md:px-4 md:py-3">{{ badge(job.status_label, status=job.status) }}</td>
            <td class="px-3 py-2 md:px-4 md:py-3">{{ job.created_at }}</td>
            <td class="px-3 py-2 md:px-4 md:py-3">
              <a href="/dashboard/jobs/{{ job.id }}" class="text-primary hover:text-primary/80">View</a>
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="5" class="px-4 py-6 text-center text-contentMuted">No jobs reference this document yet.</td>
          </tr>
        {% endfor %}
      {% endcall %}
    </div>
  {% endcall %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  function copyVersionContent(targetId) {
    const el = document.getElementById(targetId);
    if (!el) return;
    const text = el.tagName === 'TEXTAREA' ? el.value : el.textContent;
    navigator.clipboard.writeText(text).catch(() => {});
  }
  function switchVersionTab(tabKey) {
    const tabs = ['outline', 'mdx', 'html'];
    tabs.forEach((key) => {
      const btn = document.querySelector(`[data-version-tab="${key}"]`);
      const panel = document.querySelector(`[data-version-panel="${key}"]`);
      const isActive = key === tabKey;
      
      if (btn) {
        btn.setAttribute('aria-selected', isActive);
        btn.setAttribute('tabindex', isActive ? '0' : '-1');
        btn.classList.toggle('bg-surface', isActive);
      }
      
      if (panel) {
        panel.classList.toggle('hidden', !isActive);
      }
    });
  }
  
  function handleVersionTabKeydown(event, currentTab) {
    const tabs = ['outline', 'mdx', 'html'];
    const currentIndex = tabs.indexOf(currentTab);
    let targetIndex = currentIndex;
    
    switch (event.key) {
      case 'ArrowLeft':
        event.preventDefault();
        targetIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
        break;
      case 'ArrowRight':
        event.preventDefault();
        targetIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
        break;
      case 'Home':
        event.preventDefault();
        targetIndex = 0;
        break;
      case 'End':
        event.preventDefault();
        targetIndex = tabs.length - 1;
        break;
      default:
        return; // Let other keys work normally
    }
    
    const targetTab = tabs[targetIndex];
    switchVersionTab(targetTab);
    const targetButton = document.querySelector(`[data-version-tab="${targetTab}"]`);
    if (targetButton) {
      targetButton.focus();
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    switchVersionTab('outline');
  });
</script>
{% endblock %}
