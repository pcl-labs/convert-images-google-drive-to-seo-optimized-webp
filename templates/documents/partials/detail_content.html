{% from 'components/layout/page.html' import page_header %}
{% from 'components/elements/input.html' import input %}
{% from 'components/elements/button.html' import button %}
{% from 'components/elements/badge.html' import badge %}
{% from 'components/elements/card.html' import card %}
{% from 'components/elements/alert.html' import alert %}

{% set header_actions %}
  <div class="text-sm text-content break-all">
    <div class="text-xs uppercase tracking-wide text-contentMuted">Origin</div>
    <div>{{ document.origin or 'None' }}</div>
  </div>
{% endset %}
{{ page_header('Document ' ~ document.id, 'Source: ' ~ document.source_label ~ ' • Created ' ~ (document.created_at or 'unknown'), actions=header_actions) }}
<p class="text-sm text-primary"><a href="/dashboard/documents" class="hover:text-primary/80">&larr; Back to Documents</a></p>

{% set folder = drive_meta.get('folder') if drive_meta else {} %}
{% set media_folder = drive_meta.get('media') if drive_meta else {} %}
{% set doc_link = drive_meta.get('web_view_link') %}
{% set folder_link = folder.webViewLink if folder else None %}
{% set media_link = media_folder.webViewLink if media_folder else None %}
<section class="rounded-2xl border border-border/70 bg-card/70 p-5 space-y-4">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-contentMuted">{{ document.source_label }}</p>
      <h1 class="text-2xl font-semibold text-content break-words">{{ document.frontmatter.title or document.metadata.title or 'Untitled draft' }}</h1>
      <p class="text-sm text-contentMuted break-all">{{ document.origin or 'No origin recorded' }}</p>
    </div>
    <div class="flex flex-wrap gap-2 text-xs">
      {% if drive_meta.stage %}
        <span class="inline-flex items-center rounded-full border border-border px-3 py-1 uppercase tracking-wide text-[11px] text-contentMuted">
          {{ drive_meta.stage|capitalize }}
        </span>
      {% endif %}
      {% if doc_link %}
        <a href="{{ doc_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 text-primary hover:border-primary/70">Open Google Doc</a>
      {% endif %}
      {% if folder_link %}
        <a href="{{ folder_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 hover:border-primary/70">Drive folder</a>
      {% endif %}
      {% if media_link %}
        <a href="{{ media_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 hover:border-primary/70">Media folder</a>
      {% endif %}
    </div>
  </div>
  <div class="text-xs text-contentMuted flex flex-wrap gap-4">
    <span>Document ID: {{ document.id }}</span>
    {% if drive_meta.file_id %}
      <span>Drive file: {{ drive_meta.file_id }}</span>
    {% endif %}
    {% if drive_meta.revision_id %}
      <span>Revision: {{ drive_meta.revision_id[:10] }}…</span>
    {% endif %}
  </div>
</section>

<div id="doc-flash" class="space-y-2"></div>

<div class="grid gap-6 xl:grid-cols-12">
  <section class="space-y-4 xl:col-span-7">
    {% call card(title='Live MDX Preview') %}
      {% include "documents/partials/version_viewer.html" %}
    {% endcall %}
    {% if document.raw_text %}
      {% call card(title='Raw text') %}
        <pre class="whitespace-pre-wrap text-sm text-content">{{ document.raw_text }}</pre>
      {% endcall %}
    {% endif %}
    {% call card(title='Versions') %}
      <div class="space-y-3">
        {% for version in versions %}
          <article class="surface rounded-lg p-4 space-y-3">
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
              <div>
                <p class="text-sm font-semibold text-content">v{{ version.version }} &middot; {{ version.title or 'Untitled' }}</p>
                <p class="text-xs text-contentMuted">{{ version.created_at }}</p>
              </div>
              <div class="flex flex-col gap-2 text-sm sm:flex-row sm:items-center">
                <a class="text-primary hover:text-primary/80" hx-get="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}" hx-target="#version-viewer" hx-swap="outerHTML" href="#">View</a>
                <a href="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}/download?format=mdx" class="text-contentMuted hover:text-content">Download MDX</a>
                <a href="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}/download?format=html" class="text-contentMuted hover:text-content">Download HTML</a>
              </div>
            </div>
          </article>
        {% else %}
          <div class="rounded-lg border border-border p-6 text-center text-sm text-contentMuted">No versions yet.</div>
        {% endfor %}
      </div>
    {% endcall %}
  </section>
  <section class="space-y-4 xl:col-span-5">
    {% if drive_meta %}
      {% set folder = drive_meta.get('folder', {}) %}
      {% set media = drive_meta.get('media', {}) %}
      {% call card(title='Drive Workspace') %}
        <dl class="space-y-2 text-sm">
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Document folder</dt>
            <dd class="break-all">
              {% if folder.webViewLink %}
                <a href="{{ folder.webViewLink }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">
                  {{ folder.name or drive_meta.folder_id or 'Open in Drive' }}
                </a>
              {% else %}
                {{ folder.name or drive_meta.folder_id or '—' }}
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Google Doc</dt>
            <dd>
              {% if drive_meta.web_view_link %}
                <a href="{{ drive_meta.web_view_link }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">Open Google Doc</a>
              {% else %}
                {{ drive_meta.file_id or '—' }}
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Media folder</dt>
            <dd>
              {% if media.webViewLink %}
                <a href="{{ media.webViewLink }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">
                  {{ media.name or drive_meta.media_folder_id or 'Media folder' }}
                </a>
              {% else %}
                {{ media.name or drive_meta.media_folder_id or '—' }}
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Last Drive ingest</dt>
            <dd>{{ drive_meta.last_ingested_at or 'Never' }}</dd>
          </div>
        </dl>
      {% endcall %}
    {% endif %}

    {% call card(title='Jobs', actions='<a href="/dashboard/jobs?document_id=' ~ document.id ~ '" class="text-sm text-primary hover:text-primary/80">(view all)</a>') %}
      {% if jobs %}
        <ul class="divide-y divide-border/70 text-sm">
          {% for job in jobs %}
            <li class="py-2 flex items-center justify-between">
              <div>
                <p class="font-medium text-content">{{ job.kind }}</p>
                <p class="text-xs text-contentMuted">{{ job.created_at or '' }}</p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full border border-border/70 text-contentMuted">{{ job.status_label }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-contentMuted">No jobs yet. Run an ingest or generation to see activity.</p>
      {% endif %}
    {% endcall %}

    {% call card(title='Activity for this document', actions='<a href="/api/v1/jobs?document_id=' ~ document.id ~ '" class="text-sm text-primary hover:text-primary/80" target="_blank" rel="noopener">Open Activity API</a>') %}
      <p class="text-sm text-content">
        Job history now lives in the Activity API so you can filter, export, or embed however you like. Use the link above to fetch a JSON response scoped to this document.
      </p>
      <p class="mt-3 text-xs text-contentMuted">
        Tip: pass <code>status=running</code> or <code>status=failed</code> query params to zero in on specific states.
      </p>
    {% endcall %}
  </section>
</div>

<script>
  function copyVersionContent(targetId) {
    const el = document.getElementById(targetId);
    if (!el) return;
    const text = el.tagName === 'TEXTAREA' ? el.value : el.textContent;
    navigator.clipboard.writeText(text).catch(() => {});
  }
  function switchVersionTab(tabKey) {
    const tabs = ['outline', 'mdx', 'html'];
    tabs.forEach((key) => {
      const btn = document.querySelector(`[data-version-tab="${key}"]`);
      const panel = document.querySelector(`[data-version-panel="${key}"]`);
      const isActive = key === tabKey;
      if (btn) {
        btn.setAttribute('aria-selected', isActive);
        btn.setAttribute('tabindex', isActive ? '0' : '-1');
        btn.classList.toggle('bg-surface', isActive);
      }
      if (panel) {
        panel.classList.toggle('hidden', !isActive);
      }
    });
  }
  function handleVersionTabKeydown(event, currentTab) {
    const tabs = ['outline', 'mdx', 'html'];
    const currentIndex = tabs.indexOf(currentTab);
    let targetIndex = currentIndex;
    switch (event.key) {
      case 'ArrowLeft':
        event.preventDefault();
        targetIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
        break;
      case 'ArrowRight':
        event.preventDefault();
        targetIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
        break;
      case 'Home':
        event.preventDefault();
        targetIndex = 0;
        break;
      case 'End':
        event.preventDefault();
        targetIndex = tabs.length - 1;
        break;
      default:
        return;
    }
    const targetTab = tabs[targetIndex];
    switchVersionTab(targetTab);
    const targetButton = document.querySelector(`[data-version-tab="${targetTab}"]`);
    if (targetButton) {
      targetButton.focus();
    }
  }
  document.addEventListener('DOMContentLoaded', () => {
    switchVersionTab('outline');
  });
</script>
