{% extends "base.html" %}
{% set page_title = 'Activity' %}
{% from 'components/layout/page.html' import page_container, page_header %}
{% block content %}
{% call page_container() %}
  {{ page_header('Activity', 'Recent notifications') }}

  <div id="activity-feed" class="space-y-2">
    {% from 'components/elements/alert.html' import alert %}
    {% from 'components/elements/button.html' import button %}
    {% if notifications and notifications|length > 0 %}
      {% for n in notifications %}
        {% set level = n.level or 'info' %}
        <div class="space-y-3 surface rounded-lg p-4">
          {{ alert('success' if level=='success' else ('error' if level=='error' else 'info'), n.text) }}
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-end">
            {{ button('Seen', variant='ghost', attrs='hx-post="/api/notifications/' ~ n.id ~ '/seen" hx-headers=\'{"X-CSRF-Token":"{{ csrf_token }}"}\' hx-swap="none" hx-on:htmx:afterOnLoad="window.dispatchEvent(new CustomEvent(\'toast\',{detail:{type:\'info\',text:\'Marked seen\'}}))"', with_spinner=True) }}
            {{ button('Dismiss', variant='ghost', attrs='hx-post="/api/notifications/' ~ n.id ~ '/dismiss" hx-headers=\'{"X-CSRF-Token":"{{ csrf_token }}"}\' hx-swap="none" hx-on:htmx:afterOnLoad="window.dispatchEvent(new CustomEvent(\'toast\',{detail:{type:\'info\',text:\'Dismissed\'}}))"', with_spinner=True) }}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div id="activity-empty" class="text-contentMuted text-sm">No notifications yet.</div>
    {% endif %}
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const feed = document.getElementById('activity-feed');
      if (!feed) return;
      const levelClasses = {
        success: 'bg-accent/10 text-accent ring-1 ring-accent/30',
        error: 'bg-destructive/10 text-destructive ring-1 ring-destructive/30',
        info: 'bg-primary/10 text-primary ring-1 ring-primary/30'
      };
      const escapeHtml = (value) => {
        return (value || '').replace(/[&<>"']/g, (char) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[char] || char));
      };
      const escapeAttr = (value) => escapeHtml(value).replace(/"/g, '&quot;');
      window.addEventListener('notification:created', (event) => {
        const data = event.detail || {};
        if (!data.text) return;
        const wrapper = document.createElement('div');
        wrapper.className = 'space-y-3 surface rounded-lg p-4 border border-border/60 animate-in fade-in';
        const level = data.level || 'info';
        const alertClass = levelClasses[level] || levelClasses.info;
        const context = (typeof data.context === 'object' && data.context !== null) ? data.context : {};
        let href = context.href || null;
        if (!href){
          if (context.document_id){
            href = `/dashboard/documents/${context.document_id}`;
          } else if (context.job_id){
            href = `/dashboard/jobs/${context.job_id}`;
          }
        }
        wrapper.innerHTML = `
          <div class="relative rounded-md px-3 py-2 text-sm ${alertClass}">
            <div>${escapeHtml(data.text)}</div>
          </div>
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-end">
            ${href ? `<a href="${escapeAttr(href)}" class="text-xs text-primary hover:text-primary/80">Open</a>` : ''}
          </div>
        `;
        const empty = document.getElementById('activity-empty');
        if (empty) empty.remove();
        feed.prepend(wrapper);
      });
    });
  </script>
{% endcall %}
{% endblock %}
