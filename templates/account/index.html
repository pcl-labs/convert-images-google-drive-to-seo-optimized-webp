{% extends "base.html" %}
{% set page_title = 'Account' %}
{% from 'components/layout/page.html' import page_container, page_header %}
{% from 'components/elements/card.html' import card %}
{% from 'components/elements/button.html' import button %}
{% from 'components/elements/input.html' import input %}
{% from 'components/overlays/modal.html' import modal %}
{% block content %}
{% call page_container() %}
  {{ page_header('Account', 'Your profile information') }}

  {% call card(title='Profile') %}
    <dl class="space-y-3 text-sm text-content">
      <div class="flex flex-col">
        <dt class="text-xs font-semibold uppercase tracking-wide text-contentMuted">User ID</dt>
        <dd class="font-mono break-all text-content">{{ user.user_id }}</dd>
      </div>
      <div class="flex flex-col">
        <dt class="text-xs font-semibold uppercase tracking-wide text-contentMuted">GitHub ID</dt>
        <dd class="font-mono break-all text-content">{{ user.github_id or '-' }}</dd>
      </div>
      <div class="flex flex-col">
        <dt class="text-xs font-semibold uppercase tracking-wide text-contentMuted">Google ID</dt>
        <dd class="font-mono break-all text-content">{{ user.google_id or '-' }}</dd>
      </div>
      <div class="flex flex-col">
        <dt class="text-xs font-semibold uppercase tracking-wide text-contentMuted">Email</dt>
        <dd class="font-mono break-all text-content">{{ user.email or '-' }}</dd>
      </div>
      <div class="flex flex-col">
        <dt class="text-xs font-semibold uppercase tracking-wide text-contentMuted">Created</dt>
        <dd>{{ user.created_at or '-' }}</dd>
      </div>
    </dl>
  {% endcall %}

  {# Connected Accounts card #}
  {% from 'components/icons/brand_icon.html' import brand_icon %}
  {% call card(title='Connected Accounts') %}
    <div class="space-y-4">
      <div class="space-y-2">
        <h3 class="text-xs font-semibold uppercase tracking-wide text-contentMuted">Links</h3>
        <div class="divide-y divide-border surface rounded-md">
          <div class="flex items-center justify-between p-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="h-6 w-6 rounded-md bg-surfaceMuted border border-border p-1 [&>svg]:h-full [&>svg]:w-full [&>svg]:block">
                {{ brand_icon('github') }}
              </div>
              <div class="min-w-0">
                <div class="text-sm font-medium text-content">GitHub</div>
              </div>
            </div>
            {% if not user.github_id %}
              <form method="post" action="/auth/github/start">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                {{ button('Add', variant='secondary', attrs='type="submit"') }}
              </form>
            {% else %}
              <span class="inline-flex items-center rounded-full border border-border px-3 py-1 text-xs text-contentMuted bg-surfaceMuted">Connected</span>
            {% endif %}
          </div>
          <div class="flex items-center justify-between p-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="h-6 w-6 rounded-md bg-surfaceMuted border border-border p-1 [&>svg]:h-full [&>svg]:w-full [&>svg]:block">
                {{ brand_icon('google') }}
              </div>
              <div class="min-w-0">
                <div class="text-sm font-medium text-content">Google</div>
              </div>
            </div>
            {% if not user.google_id %}
              <form method="post" action="/auth/google/login/start">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                {{ button('Add', variant='secondary', attrs='type="submit"') }}
              </form>
            {% else %}
              <span class="inline-flex items-center rounded-full border border-border px-3 py-1 text-xs text-contentMuted bg-surfaceMuted">Connected</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="space-y-2">
        <h3 class="text-xs font-semibold uppercase tracking-wide text-contentMuted">Email</h3>
        <div class="surface rounded-md divide-y divide-border">
          <div class="flex items-center justify-between p-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="h-8 w-8 rounded-md bg-surfaceMuted border border-border p-1.5">
                <svg viewBox="0 0 24 24" class="h-full w-full text-content" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                  <rect x="3" y="5" width="18" height="14" rx="2" ry="2"/>
                  <path d="M3 7l9 6 9-6"/>
                </svg>
              </div>
              <div class="min-w-0">
                <div class="text-sm text-content truncate">{{ user.email or '-' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p class="text-xs text-contentMuted">
        To enable Drive/YouTube workflows, link Google integrations on the <a href="/dashboard/integrations" class="text-primary hover:text-primary/80">Integrations</a> page.
      </p>
    </div>
  {% endcall %}

  {% call card(title='Appearance') %}
    <div x-data="appearanceControls()" x-cloak class="space-y-4">
      <p class="text-sm text-contentMuted">Choose how Quill looks across sessions.</p>
      <div class="grid gap-3 sm:grid-cols-3">
        <template x-for="option in options" :key="option.value">
          <label
            class="flex h-full cursor-pointer flex-col gap-1 rounded-lg border border-border bg-surface p-3 text-left shadow-sm transition focus-within:ring-2 focus-within:ring-ring/40"
            :class="preference === option.value ? 'border-primary ring-2 ring-primary/30' : 'hover:border-contentMuted/50'"
          >
            <span class="text-sm font-semibold text-content" x-text="option.label"></span>
            <span class="text-xs text-contentMuted" x-text="option.description"></span>
            <input
              class="sr-only"
              type="radio"
              name="appearance"
              :value="option.value"
              :checked="preference === option.value"
              @change="select(option.value)"
            />
          </label>
        </template>
      </div>
      <p class="text-xs text-contentMuted">
        Currently using <span class="font-semibold text-content" x-text="resolvedText()"></span>.
      </p>
    </div>
  {% endcall %}

  {% call card(title='Danger zone') %}
    <div class="space-y-3">
      <div class="space-y-1">
        <h3 class="text-sm font-semibold text-content">Delete account</h3>
        <p class="text-sm text-contentMuted">Permanently remove your account, API keys, jobs, and document history. This action cannot be undone.</p>
      </div>
      {% if delete_error %}
        <p class="text-xs text-destructive" role="status">{{ delete_error }}</p>
      {% endif %}
      <div class="flex items-center justify-end">
        {{ button('Delete account', variant='destructive', attrs='type="button" @click="$dispatch(\'open-delete-account\')"', extra_classes='inline-flex items-center gap-2') }}
      </div>
    </div>
  {% endcall %}

  <div class="flex flex-col items-stretch gap-2 md:flex-row md:justify-end">
    <form method="post" action="/auth/logout">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
      {{ button('Log out', variant='secondary', attrs='type="submit"', extra_classes='inline-flex items-center gap-2') }}
    </form>
  </div>
{% endcall %}

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('appearanceControls', () => ({
      options: [
        { value: 'system', label: 'System', description: 'Follow your device setting' },
        { value: 'light', label: 'Light', description: 'Always use light mode' },
        { value: 'dark', label: 'Dark', description: 'Always use dark mode' }
      ],
      preference: 'system',
      resolved: document.documentElement.classList.contains('dark') ? 'dark' : 'light',
      media: window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null,
      init(){
        if(window.themePreference){
          this.preference = window.themePreference.get();
        } else if(this.media && this.media.matches){
          this.preference = 'dark';
        } else if(!window.themePreference){
          this.preference = 'light';
        }
        this.resolved = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        this.__handler = (event) => {
          if(event && event.detail){
            this.preference = event.detail.theme || this.preference;
            this.resolved = event.detail.resolved || this.resolved;
          }
        };
        window.addEventListener('theme-change', this.__handler);
      },
      select(value){
        this.preference = value;
        if(window.themePreference){
          window.themePreference.set(value);
        } else {
          this.resolved = value === 'system'
            ? (this.media && this.media.matches ? 'dark' : 'light')
            : value;
        }
      },
      resolvedText(){
        return this.resolved === 'dark' ? 'dark mode' : 'light mode';
      }
    }));
  });
</script>

{% call modal('delete-account', title='Delete account', confirm_text='Delete', cancel_text='Cancel') %}
  <div class="space-y-4">
    <p class="text-sm text-content">Deleting your account immediately removes all jobs, documents, API keys, and stored OAuth tokens. There is no way to restore this data.</p>
    <div
      x-data="{ submit(){ if(this.$refs.form && this.$refs.form.reportValidity()){ this.$refs.form.requestSubmit(); } } }"
      @confirm-delete-account.window="submit()"
      class="space-y-3"
    >
      <form x-ref="form" method="post" action="/dashboard/account/delete" class="space-y-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
        <p id="delete-confirm-hint" class="text-sm text-contentMuted">Type <span class="font-semibold text-content">DELETE</span> below to confirm that you understand this action cannot be undone.</p>
        {{ input('confirmation', label='Confirmation', value=delete_value, placeholder='DELETE', attrs='required pattern="DELETE" aria-describedby="delete-confirm-hint" autocomplete="off" spellcheck="false" inputmode="text" data-autofocus', error=delete_error) }}
      </form>
    </div>
  </div>
{% endcall %}

{% if delete_error %}
  <script>
    window.addEventListener('DOMContentLoaded', function(){
      window.dispatchEvent(new CustomEvent('open-delete-account'));
    });
  </script>
{% endif %}
{% endblock %}
