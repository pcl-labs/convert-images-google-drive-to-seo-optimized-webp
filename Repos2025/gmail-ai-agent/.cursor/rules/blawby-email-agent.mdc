---
description: 
globs: 
alwaysApply: true
---
---

# ğŸ§­ Cursor Dev Ruleset â€“ Blawby Gmail Agent

> This ruleset defines conventions and resource links for developing `agent.blawby.com`, including Gmail Add-On logic, Cloudflare Workers, and Cloudflare Vectorize.

---

## ğŸ“ Project Structure Guidelines

```plaintext
/src
  /workers              # All Cloudflare Worker logic
    gmailAuth.ts
    labelClassifier.ts
    generateReply.ts
    billingLogger.ts
    whisperPreview.ts
    vectorIndexer.ts
  /lib
    openaiClient.ts     # Prompt orchestration + embeddings
    vectorClient.ts     # Cloudflare Vectorize SDK wrapper
    utils.ts
/voice-profiles
  user-[id].json        # Local testing / Voice profile exports
/scripts
  preprocessEmails.ts   # Local tools for email prep / chunking

/.github/workflows
  deploy.yml            # Wrangler + Vite + Add-On deploy pipeline
```

---

## â˜ï¸ Cloudflare Worker Rules

- Use **TypeScript**
- Deploy via `wrangler`
- Use `fetch()` for OpenAI + Gmail APIs
- Store Gmail tokens and metadata in **Cloudflare KV**
- Avoid large payloads; offload to **Vectorize** or **R2** when necessary

### Docs:
- ğŸ”§ [Cloudflare Workers Docs](https://developers.cloudflare.com/workers/)
- ğŸ§° [KV Storage Docs](https://developers.cloudflare.com/workers/runtime-apis/kv/)
- ğŸ§© [D1 (Cloudflare DB) Docs](https://developers.cloudflare.com/d1/)

---

## ğŸ§  Cloudflare Vectorize Rules

- Use **`text-embedding-ada-002`** (OpenAI) or Claude embedding models
- Vector metadata **must include**:
  - `thread_id`, `subject`, `client_name`, `timestamp`, `summary`, `user_id`
- Chunk emails to ~500 tokens max
- Use cosine similarity search to fetch similar past replies or cases
- Rebuild index after onboarding, and when enough new data is added

### Docs:
- ğŸ“Œ [Cloudflare Vectorize Official Docs](https://developers.cloudflare.com/vectorize/)
- ğŸ“¦ [Vector Metadata Format Guide](https://developers.cloudflare.com/vectorize/build/metadata/)
- ğŸ” [Querying Embeddings](https://developers.cloudflare.com/vectorize/query/)

---

## âœï¸ Prompt Engineering Rules

- Store prompt templates in `openaiClient.ts`
- Include:
  - User's **Voice Profile**
  - Message thread summary
  - Snippets from **Vectorize search**
- Prompt style: system + user messages (chat format)

### Docs:
- ğŸ§  [OpenAI API Docs](https://platform.openai.com/docs/)
- ğŸ“ [Best Practices for Prompt Design](https://platform.openai.com/docs/guides/gpt)

---

## âœï¸ Gmail Add-On (Sidebar) Rules

- Written in **Google Apps Script (JavaScript)**
- UI must include:
  - â€œGenerate Replyâ€ button
  - Display of Whisper-mode similar replies
  - Insert-to-draft button
  - Confirmed billing log toggle
- Do **not** auto-send any replies

### Docs:
- ğŸ“¨ [Gmail Add-On Docs](https://developers.google.com/gmail/add-ons/)
- ğŸ¨ [Card UI Widgets (Sidebar)](https://developers.google.com/gmail/add-ons/guides/card-actions)
- ğŸ” [Gmail OAuth Scopes](https://developers.google.com/gmail/api/auth/scopes)

---

## ğŸ§ª Local Dev + CI Rules

- Use `vite` for local testing / frontend preview
- Use `wrangler dev` for Workers testing
- Use GitHub Actions for:
  - Worker deploys
  - Sidebar packaging (optional Apps Script CI)

### Docs:
- ğŸš€ [Wrangler v3 Docs](https://developers.cloudflare.com/workers/wrangler/)
- âš™ï¸ [GitHub Actions + Wrangler](https://developers.cloudflare.com/workers/wrangler/commands/#publish)

---

## âœ… Commit & Naming Rules

- Feature branches: `feature/label-classifier`, `feature/voice-profile`
- PR titles: `feat: Add Whisper-mode preview`, `fix: token refresh bug`
- Use conventional commits

---

## ğŸ§  Additional References

- [Cloudflare Blog: Intro to Vectorize](https://blog.cloudflare.com/introducing-vectorize/)
- [OpenAI Embedding API](https://platform.openai.com/docs/guides/embeddings)
- [Apps Script Add-On Deployment](https://developers.google.com/workspace/marketplace/create-publish)

---