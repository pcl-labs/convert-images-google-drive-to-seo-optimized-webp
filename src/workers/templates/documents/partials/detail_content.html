{% from 'components/layout/page.html' import page_header %}
{% from 'components/elements/input.html' import input %}
{% from 'components/elements/button.html' import button %}
{% from 'components/elements/badge.html' import badge %}
{% from 'components/elements/card.html' import card %}
{% from 'components/elements/alert.html' import alert %}

{% set header_actions %}
  <div class="text-sm text-content break-all">
    <div class="text-xs uppercase tracking-wide text-contentMuted">Origin</div>
    <div>{{ document.origin or 'None' }}</div>
  </div>
{% endset %}
{{ page_header('Document ' ~ document.id, 'Source: ' ~ document.source_label ~ ' • Created ' ~ (document.created_at or 'unknown'), actions=header_actions) }}
<p class="text-sm text-primary"><a href="/dashboard/documents" class="hover:text-primary/80">&larr; Back to Documents</a></p>

{% set folder = drive_meta.get('folder') if drive_meta else {} %}
{% set media_folder = drive_meta.get('media') if drive_meta else {} %}
{% set doc_link = drive_meta.get('web_view_link') %}
{% set folder_link = folder.webViewLink if folder else None %}
{% set media_link = media_folder.webViewLink if media_folder else None %}
<section class="rounded-2xl border border-border/70 bg-card/70 p-5 space-y-4">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-contentMuted">{{ document.source_label }}</p>
      <h1 class="text-2xl font-semibold text-content break-words">{{ document.frontmatter.title or document.metadata.title or 'Untitled draft' }}</h1>
      <p class="text-sm text-contentMuted break-all">{{ document.origin or 'No origin recorded' }}</p>
    </div>
    <div class="flex flex-wrap gap-2 text-xs">
      {% if drive_meta.stage %}
        <span class="inline-flex items-center rounded-full border border-border px-3 py-1 uppercase tracking-wide text-[11px] text-contentMuted">
          {{ drive_meta.stage|capitalize }}
        </span>
      {% endif %}
      {% if doc_link %}
        <a href="{{ doc_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 text-primary hover:border-primary/70">Open Google Doc</a>
      {% endif %}
      {% if folder_link %}
        <a href="{{ folder_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 hover:border-primary/70">Drive folder</a>
      {% endif %}
      {% if media_link %}
        <a href="{{ media_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 hover:border-primary/70">Media folder</a>
      {% endif %}
      <form hx-post="/dashboard/documents/{{ document.id }}/drive/sync" hx-target="#doc-flash" hx-swap="innerHTML" class="inline-flex" aria-label="Sync Drive">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="inline-flex items-center rounded-full border border-border px-3 py-1 text-content hover:border-primary/70">
          Sync Drive
        </button>
      </form>
    </div>
  </div>
  <div class="text-xs text-contentMuted flex flex-wrap gap-4">
    <span>Document ID: {{ document.id }}</span>
    {% if drive_meta.file_id %}
      <span>Drive file: {{ drive_meta.file_id }}</span>
    {% endif %}
    {% if drive_meta.revision_id %}
      <span>Revision: {{ drive_meta.revision_id[:10] }}…</span>
    {% endif %}
  </div>
</section>

<div id="doc-flash" class="space-y-2"></div>

{% set latest_gen = document.latest_generation %}
{% if latest_gen and (latest_gen.engine or latest_gen.model) %}
  <div class="rounded-2xl border border-border/60 bg-card/60 p-4 space-y-1">
    <p class="text-xs uppercase tracking-wide text-contentMuted">Latest AI draft</p>
    <p class="text-sm text-content">
      {{ latest_gen.engine|default('AI')|title }}
      {% if latest_gen.model %}
        · {{ latest_gen.model }}
      {% endif %}
      {% if latest_gen.tone %}
        · tone {{ latest_gen.tone }}
      {% endif %}
    </p>
    {% if latest_gen.generated_at %}
      <p class="text-xs text-contentMuted">Generated {{ latest_gen.generated_at }}</p>
    {% endif %}
  </div>
{% endif %}

  <div class="grid gap-6 xl:grid-cols-12">
  <section class="space-y-4 xl:col-span-7">
{% call card(title='Live MDX Preview') %}
  {% include "documents/partials/version_viewer.html" %}
{% endcall %}

{% set content_plan = document.content_plan %}
{% set plan_sections = content_plan.sections if content_plan and content_plan.sections else [] %}
{% set has_plan = plan_sections|length > 0 %}
{% set has_outline = document.latest_outline and document.latest_outline|length > 0 %}
{% call card(title='Content plan') %}
  <div class="space-y-3">
    <p class="text-sm text-contentMuted">
      {% if has_plan %}
        Schema-aware plan generated during the latest pipeline run. Sections feed both the AI composer and Drive mirrors.
      {% else %}
        Plan/outline results will appear here once the content pipeline runs.
      {% endif %}
    </p>
    {% if has_plan %}
      <ol class="space-y-3 text-sm text-content">
        {% for section in plan_sections %}
          <li class="rounded-lg border border-border/60 p-3">
            <div class="flex items-center justify-between gap-3">
              <p class="font-semibold">{{ section.title }}</p>
              {% if section.purpose %}
                <span class="text-xs uppercase tracking-wide text-contentMuted">{{ section.purpose|replace('_', ' ') }}</span>
              {% endif %}
            </div>
            <p class="mt-1 text-contentMuted">{{ section.summary }}</p>
            {% if section.key_points %}
              <ul class="mt-2 list-disc list-inside space-y-1 text-contentMuted">
                {% for point in section.key_points %}
                  <li>{{ point }}</li>
                {% endfor %}
              </ul>
            {% endif %}
            {% if section.cta %}
              <div class="mt-2 text-xs font-semibold uppercase tracking-wide text-primary">Call to action</div>
            {% endif %}
            {% if section.call_to_action %}
              <p class="text-xs text-contentMuted mt-1">{{ section.call_to_action }}</p>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
      {% if content_plan.cta %}
        <div class="rounded-lg bg-surfaceMuted p-3 text-sm text-content">
          <p class="font-semibold">CTA</p>
          <p class="text-contentMuted">{{ content_plan.cta.summary or 'Summarize the key takeaways and invite the reader to act.' }}</p>
          {% if content_plan.cta.action %}
            <p class="text-xs uppercase tracking-wide text-primary mt-1">{{ content_plan.cta.action }}</p>
          {% endif %}
        </div>
      {% endif %}
    {% elif has_outline %}
      <ol class="list-decimal list-inside space-y-2 text-sm text-content">
        {% for item in document.latest_outline %}
          <li>
            <div class="font-semibold">{{ item.title or ('Section ' ~ (loop.index)) }}</div>
            {% if item.summary %}
              <div class="text-contentMuted">{{ item.summary }}</div>
            {% endif %}
          </li>
        {% endfor %}
      </ol>
    {% else %}
      <p class="text-xs text-contentMuted">Plan results will appear here once generated.</p>
    {% endif %}
  </div>
{% endcall %}
    {% call card(title='AI blog generation') %}
      <div class="space-y-4 text-sm">
        <p class="text-contentMuted">
          Generate a full blog draft from this document. Content type controls the schema we target (default is Schema.org BlogPosting) and instructions are passed directly to the composer. The draft is versioned and synced back to Drive automatically.
        </p>
        <form id="document-generate-form" data-document-id="{{ document.id }}" class="space-y-3">
          <input type="hidden" name="tone" value="informative">
          <input type="hidden" name="max_sections" value="5">
          <input type="hidden" name="target_chapters" value="4">
          <input type="hidden" name="include_images" value="on">
          {% set current_type = document.latest_generation.content_type if document.latest_generation else 'https://schema.org/BlogPosting' %}
          <label class="block text-xs font-semibold uppercase tracking-wide text-contentMuted">Content type</label>
          <select name="content_type" class="w-full rounded-lg border border-border bg-card/80 px-3 py-2 text-sm text-content focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary">
            {% for value, label in content_schema_choices %}
              <option value="{{ value }}" {% if current_type == value or (not current_type and loop.first) %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <label class="block text-xs font-semibold uppercase tracking-wide text-contentMuted">Instructions (optional)</label>
          <textarea name="instructions" rows="3" class="w-full rounded-lg border border-border bg-card/80 px-3 py-2 text-sm text-content focus:border-primary focus:outline-none focus:ring-1 focus:ring-primary" placeholder="Add any constraints, key bullets, or tone guidance..."></textarea>
          <button type="submit" class="inline-flex items-center rounded-full border border-border px-4 py-2 text-sm font-medium text-content hover:border-primary/70">
            Generate blog draft
          </button>
        </form>
      </div>
    {% endcall %}
    {% if document.raw_text %}
      {% call card(title='Raw text') %}
        <pre class="whitespace-pre-wrap text-sm text-content">{{ document.raw_text }}</pre>
      {% endcall %}
    {% endif %}
    {% call card(title='Versions') %}
      <div class="space-y-3">
        {% for version in versions %}
          <article class="surface rounded-lg p-4 space-y-3">
            <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
              <div>
                <p class="text-sm font-semibold text-content">v{{ version.version }} &middot; {{ version.title or 'Untitled' }}</p>
                <p class="text-xs text-contentMuted">{{ version.created_at }}</p>
              </div>
              <div class="flex flex-col gap-2 text-sm sm:flex-row sm:items-center">
                <a class="text-primary hover:text-primary/80" hx-get="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}" hx-target="#version-viewer" hx-swap="outerHTML" href="#">View</a>
                <a href="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}/download?format=mdx" class="text-contentMuted hover:text-content">Download MDX</a>
                <a href="/dashboard/documents/{{ document.id }}/versions/{{ version.version_id }}/download?format=html" class="text-contentMuted hover:text-content">Download HTML</a>
              </div>
            </div>
          </article>
        {% else %}
          <div class="rounded-lg border border-border p-6 text-center text-sm text-contentMuted">No versions yet.</div>
        {% endfor %}
      </div>
    {% endcall %}
  </section>
  <section class="space-y-4 xl:col-span-5">
    {% if drive_meta %}
      {% set folder = drive_meta.get('folder', {}) %}
      {% set media = drive_meta.get('media', {}) %}
      {% call card(title='Drive Workspace') %}
        <dl class="space-y-2 text-sm">
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Document folder</dt>
            <dd class="break-all">
              {% if folder.webViewLink %}
                <a href="{{ folder.webViewLink }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">
                  {{ folder.name or drive_meta.folder_id or 'Open in Drive' }}
                </a>
              {% else %}
                {{ folder.name or drive_meta.folder_id or '—' }}
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Google Doc</dt>
            <dd>
              {% if drive_meta.web_view_link %}
                <a href="{{ drive_meta.web_view_link }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">Open Google Doc</a>
              {% else %}
                {{ drive_meta.file_id or '—' }}
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Media folder</dt>
            <dd>
              {% if media.webViewLink %}
                <a href="{{ media.webViewLink }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">
                  {{ media.name or drive_meta.media_folder_id or 'Media folder' }}
                </a>
              {% else %}
                {{ media.name or drive_meta.media_folder_id or '—' }}
              {% endif %}
            </dd>
          </div>
          <div>
            <dt class="text-contentMuted uppercase text-xs tracking-wide">Last Drive ingest</dt>
            <dd>{{ drive_meta.last_ingested_at or 'Never' }}</dd>
          </div>
        </dl>
      {% endcall %}
    {% endif %}

    {% call card(title='Jobs', actions='<a href="/dashboard/jobs?document_id=' ~ document.id ~ '" class="text-sm text-primary hover:text-primary/80">(view all)</a>') %}
      {% if jobs %}
        <ul class="divide-y divide-border/70 text-sm">
          {% for job in jobs %}
            <li class="py-2 flex items-center justify-between">
              <div class="space-y-1">
                <p class="font-medium text-content">{{ job.kind }}</p>
                <p class="text-xs text-contentMuted">{{ job.created_at or '' }}</p>
                <p class="font-mono text-[11px] text-contentMuted break-all">{{ job.id }}</p>
                <div class="flex flex-wrap gap-3 text-[11px] text-contentMuted">
                  <a href="/v1/jobs/{{ job.id }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">Job API</a>
                  <a href="/api/pipelines/stream?job_id={{ job.id }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">Stream</a>
                  {% if job.document_id %}
                    <a href="/v1/documents/{{ job.document_id }}" target="_blank" rel="noopener" class="text-primary hover:text-primary/80">Document API</a>
                  {% endif %}
                </div>
              </div>
              <span class="text-xs px-2 py-1 rounded-full border border-border/70 text-contentMuted">{{ job.status_label }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-contentMuted">No jobs yet. Run an ingest or generation to see activity.</p>
      {% endif %}
    {% endcall %}

    {% call card(title='Activity for this document', actions='<a href="/api/v1/jobs?document_id=' ~ document.id ~ '" class="text-sm text-primary hover:text-primary/80" target="_blank" rel="noopener">Open Activity API</a>') %}
      <p class="text-sm text-content">
        Job history now lives in the Activity API so you can filter, export, or embed however you like. Use the link above to fetch a JSON response scoped to this document.
      </p>
      <p class="mt-3 text-xs text-contentMuted">
        Tip: pass <code>status=running</code> or <code>status=failed</code> query params to zero in on specific states.
      </p>
    {% endcall %}
  </section>
</div>

<script>
  const VERSION_TABS = Object.freeze(['outline', 'mdx', 'html']);
  function copyVersionContent(targetId, label) {
    const el = document.getElementById(targetId);
    if (!el) return;
    const text = el.tagName === 'TEXTAREA' ? el.value : el.textContent;
    navigator.clipboard.writeText(text).then(() => {
      window.dispatchEvent(new CustomEvent('toast', { detail: { type: 'success', text: `${label || 'Content'} copied` } }));
    }).catch(() => {
      window.dispatchEvent(new CustomEvent('toast', { detail: { type: 'error', text: `Failed to copy ${label || 'content'}` } }));
    });
  }
  function switchVersionTab(tabKey) {
    VERSION_TABS.forEach((key) => {
      const btn = document.querySelector(`[data-version-tab="${key}"]`);
      const panel = document.querySelector(`[data-version-panel="${key}"]`);
      const isActive = key === tabKey;
      if (btn) {
        btn.setAttribute('aria-selected', isActive);
        btn.setAttribute('tabindex', isActive ? '0' : '-1');
        btn.classList.toggle('bg-surface', isActive);
      }
      if (panel) {
        panel.classList.toggle('hidden', !isActive);
      }
    });
  }
  function handleVersionTabKeydown(event, currentTab) {
    const currentIndex = VERSION_TABS.indexOf(currentTab);
    let targetIndex = currentIndex;
    switch (event.key) {
      case 'ArrowLeft':
        event.preventDefault();
        targetIndex = currentIndex > 0 ? currentIndex - 1 : VERSION_TABS.length - 1;
        break;
      case 'ArrowRight':
        event.preventDefault();
        targetIndex = currentIndex < VERSION_TABS.length - 1 ? currentIndex + 1 : 0;
        break;
      case 'Home':
        event.preventDefault();
        targetIndex = 0;
        break;
      case 'End':
        event.preventDefault();
        targetIndex = VERSION_TABS.length - 1;
        break;
      default:
        return;
    }
    const targetTab = VERSION_TABS[targetIndex];
    switchVersionTab(targetTab);
    const targetButton = document.querySelector(`[data-version-tab="${targetTab}"]`);
    if (targetButton) {
      targetButton.focus();
    }
  }
  function extractContentMeta(payload){
    if(!payload || typeof payload !== 'object'){
      return { jobId: null, documentId: null, versionId: null, message: 'Request completed.' };
    }
    if(payload.job_id){
      return {
        jobId: payload.job_id,
        documentId: payload.document_id || null,
        versionId: payload.version_id || null,
        message: `Job ${payload.job_id} queued`,
      };
    }
    const documentId = payload.document_id || null;
    const versionId = payload.version_id || (payload.content && payload.content.version_id) || null;
    let message = 'Request completed.';
    if(versionId){
      message = `Version ${versionId} ready`;
    } else if(documentId){
      message = `Document ${documentId} updated`;
    }
    return { jobId: null, documentId, versionId, message };
  }
  function buildContentLinks(meta){
    const links = {};
    if(!meta || typeof meta !== 'object'){
      return links;
    }
    if(meta.documentId){
      links.document = `/v1/documents/${meta.documentId}`;
      if(meta.versionId){
        links.version = `/v1/documents/${meta.documentId}/versions/${meta.versionId}`;
      }
    }
    if(meta.jobId){
      links.job = `/v1/jobs/${meta.jobId}`;
      links.stream = `/api/pipelines/stream?job_id=${meta.jobId}`;
    }
    return links;
  }
  function renderDocFlash(kind, meta){
    const flashEl = document.getElementById('doc-flash');
    if(!flashEl){
      return;
    }
    flashEl.innerHTML = '';
    const wrapper = document.createElement('div');
    wrapper.className = `rounded-lg border px-3 py-2 text-sm ${kind === 'success' ? 'border-accent/40 bg-accent/5 text-accent' : 'border-destructive/40 bg-destructive/5 text-destructive'}`;
    const title = document.createElement('p');
    title.className = 'font-medium';
    title.textContent = meta && meta.message ? meta.message : (kind === 'success' ? 'Request completed.' : 'Request failed.');
    wrapper.appendChild(title);
    const links = buildContentLinks(meta);
    const linkLabels = { document: 'Document API', version: 'Version API', job: 'Job API', stream: 'Live stream' };
    const linkKeys = Object.keys(links);
    if(linkKeys.length){
      const linkWrap = document.createElement('div');
      linkWrap.className = 'mt-2 flex flex-wrap gap-3 text-xs text-contentMuted';
      linkKeys.forEach((key) => {
        if(!links[key]){
          return;
        }
        const anchor = document.createElement('a');
        anchor.href = links[key];
        anchor.target = '_blank';
        anchor.rel = 'noopener';
        anchor.className = 'text-primary hover:text-primary/80';
        anchor.textContent = `${linkLabels[key] || 'Open'} →`;
        linkWrap.appendChild(anchor);
      });
      wrapper.appendChild(linkWrap);
    }
    flashEl.appendChild(wrapper);
  }
  function buildDocumentPayload(form){
    const formData = new FormData(form);
    const documentId = form.getAttribute('data-document-id') || '';
    const payload = {
      document_id: documentId,
      mode: 'structured',
      async: true,
      options: {},
    };
    const tone = (formData.get('tone') || '').trim();
    if(tone){
      payload.options.tone = tone;
    }
    const maxSections = parseInt(formData.get('max_sections'), 10);
    if(Number.isFinite(maxSections)){
      payload.options.max_sections = maxSections;
    }
    const targetChapters = parseInt(formData.get('target_chapters'), 10);
    if(Number.isFinite(targetChapters)){
      payload.options.target_chapters = targetChapters;
    }
    const includeImages = formData.get('include_images');
    if(typeof includeImages === 'string'){
      payload.options.include_images = includeImages === 'on' || includeImages === 'true';
    }
    const contentType = (formData.get('content_type') || '').trim();
    payload.options.content_type = contentType || 'https://schema.org/BlogPosting';
    const instructions = (formData.get('instructions') || '').trim();
    if(instructions){
      payload.options.instructions = instructions;
    }
    return payload;
  }
  async function handleDocumentGenerate(event){
    event.preventDefault();
    const form = event.target;
    const payload = buildDocumentPayload(form);
    if(!payload.document_id){
      renderDocFlash('error', { message: 'Document ID missing from form.' });
      return;
    }
    const submitBtn = form.querySelector('button[type="submit"]');
    if(submitBtn){
      submitBtn.disabled = true;
    }
    try {
      const response = await fetch('/v1/content/blog_from_document', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload),
      });
      let data = {};
      try {
        data = await response.json();
      } catch (_) {
        data = {};
      }
      if(!response.ok){
        const message = (data && data.detail) || 'Failed to queue blog generation.';
        renderDocFlash('error', { message });
        return;
      }
      const meta = extractContentMeta(data);
      renderDocFlash('success', meta);
    } catch (err) {
      renderDocFlash('error', { message: err && err.message ? err.message : 'Failed to queue blog generation.' });
    } finally {
      if(submitBtn){
        submitBtn.disabled = false;
      }
    }
  }
  function initDocumentContentForm(){
    const form = document.getElementById('document-generate-form');
    if(!form || form.__contentBound){
      return;
    }
    form.addEventListener('submit', handleDocumentGenerate);
    form.__contentBound = true;
  }
  document.addEventListener('DOMContentLoaded', () => {
    switchVersionTab('outline');
    initDocumentContentForm();
  });
  document.addEventListener('htmx:afterSwap', (event) => {
    const target = event.detail && event.detail.target;
    if(target && target.id === 'document-detail-root'){
      initDocumentContentForm();
    }
  });
</script>
