{% from 'components/layout/page.html' import page_header %}
{% from 'components/elements/input.html' import input %}
{% from 'components/elements/button.html' import button %}
{% from 'components/elements/badge.html' import badge %}
{% from 'components/elements/card.html' import card %}
{% from 'components/elements/alert.html' import alert %}

{{ page_header('Document ' ~ document.id, 'Source: ' ~ document.source_label ~ ' • Created ' ~ (document.created_at or 'unknown')) }}
<p class="text-sm text-primary"><a href="/dashboard/documents" class="hover:text-primary/80">&larr; Back to Documents</a></p>

{% set folder = drive_meta.get('folder') if drive_meta else {} %}
{% set media_folder = drive_meta.get('media') if drive_meta else {} %}
{% set doc_link = drive_meta.get('web_view_link') %}
{% set folder_link = folder.webViewLink if folder else None %}
{% set media_link = media_folder.webViewLink if media_folder else None %}
<section class="rounded-2xl border border-border/70 bg-card/70 p-5 space-y-4">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-xs uppercase tracking-wide text-contentMuted">{{ document.source_label }}</p>
      <h1 class="text-2xl font-semibold text-content break-words">
        {{ document.frontmatter.title or 'Untitled draft' }}
      </h1>
      <p class="text-sm text-contentMuted break-all">{{ document.origin or 'No origin recorded' }}</p>
    </div>
    <div class="flex flex-wrap gap-2 text-xs">
      {% if drive_meta.stage %}
        <span class="inline-flex items-center rounded-full border border-border px-3 py-1 uppercase tracking-wide text-[11px] text-contentMuted">
          {{ drive_meta.stage|capitalize }}
        </span>
      {% endif %}
      {% if doc_link %}
        <a href="{{ doc_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 text-primary hover:border-primary/70">Open Google Doc</a>
      {% endif %}
      {% if folder_link %}
        <a href="{{ folder_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 hover:border-primary/70">Drive folder</a>
      {% endif %}
      {% if media_link %}
        <a href="{{ media_link }}" target="_blank" rel="noopener" class="inline-flex items-center rounded-full border border-border px-3 py-1 hover:border-primary/70">Media folder</a>
      {% endif %}
      <form hx-post="/dashboard/documents/{{ document.id }}/drive/sync" hx-target="#doc-flash" hx-swap="innerHTML" class="inline-flex" aria-label="Sync Drive">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button type="submit" class="inline-flex items-center rounded-full border border-border px-3 py-1 text-content hover:border-primary/70">
          Sync Drive
        </button>
      </form>
    </div>
  </div>
  <div class="text-xs text-contentMuted flex flex-wrap gap-4">
    <span>Document ID: {{ document.id }}</span>
    {% if drive_meta.file_id %}
      <span>Drive file: {{ drive_meta.file_id }}</span>
    {% endif %}
    {% if drive_meta.revision_id %}
      <span>Revision: {{ drive_meta.revision_id[:10] }}…</span>
    {% endif %}
  </div>
</section>

<div id="doc-flash" class="space-y-2"></div>
<section class="mt-6 space-y-4">
  {% call card(title='Debug · Document JSON') %}
    <pre class="whitespace-pre-wrap text-xs font-mono text-content overflow-auto">{{ document | tojson(indent=2) }}</pre>
  {% endcall %}
</section>
