{% from 'components/layout/page.html' import page_container, page_header %}

{% call page_container() %}
  {% if load_error %}
    {% from 'components/elements/alert.html' import alert %}
    <div>{{ alert('error', load_error) }}</div>
  {% endif %}

  {% from 'components/elements/dropdown.html' import dropdown %}
  {% set label = (current_status or 'all')|title %}
  {% set trigger %}
    <button @click="toggle()" @keydown.escape="close()" aria-haspopup="menu" :aria-expanded="open.toString()" class="inline-flex w-full items-center justify-between gap-2 rounded-md border border-border bg-surfaceMuted/80 px-3 py-2 text-sm text-content hover:bg-surfaceMuted md:w-auto">
      <span>Status: {{ label }}</span>
      <svg class="h-4 w-4 text-contentMuted" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.17l3.71-3.94a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
    </button>
  {% endset %}
  {% set status_dropdown %}
    {% call dropdown(trigger, align='right', width='sm') %}
      <nav class="py-1 text-sm" role="menu">
        <a href="/dashboard/jobs" class="block px-3 py-2 text-content hover:bg-surfaceMuted/60" role="menuitem">All</a>
        <a href="/dashboard/jobs?status=queued" class="block px-3 py-2 text-content hover:bg-surfaceMuted/60" role="menuitem">Queued</a>
        <a href="/dashboard/jobs?status=running" class="block px-3 py-2 text-content hover:bg-surfaceMuted/60" role="menuitem">Running</a>
        <a href="/dashboard/jobs?status=completed" class="block px-3 py-2 text-content hover:bg-surfaceMuted/60" role="menuitem">Completed</a>
        <a href="/dashboard/jobs?status=failed" class="block px-3 py-2 text-content hover:bg-surfaceMuted/60" role="menuitem">Failed</a>
      </nav>
    {% endcall %}
  {% endset %}

  {{ page_header('Jobs', 'Monitor and manage processing jobs', actions=status_dropdown) }}

  <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
    {% set queued = stats.pending or stats.queued or 0 %}
    {% set running = stats.processing or stats.running or 0 %}
    {% set completed = stats.completed or 0 %}
    <div class="bg-surfaceMuted rounded-xl p-4">
      <p class="text-xs uppercase tracking-wide text-contentMuted">Queued</p>
      <p class="mt-2 text-2xl font-semibold text-content">{{ queued }}</p>
      <p class="text-xs text-contentMuted mt-1">Awaiting worker pickup</p>
    </div>
    <div class="bg-surfaceMuted rounded-xl p-4">
      <p class="text-xs uppercase tracking-wide text-contentMuted">Running</p>
      <p class="mt-2 text-2xl font-semibold text-content">{{ running }}</p>
      <p class="text-xs text-contentMuted mt-1">Actively optimizing</p>
    </div>
    <div class="bg-surfaceMuted rounded-xl p-4">
      <p class="text-xs uppercase tracking-wide text-contentMuted">Completed</p>
      <p class="mt-2 text-2xl font-semibold text-content">{{ completed }}</p>
      <p class="text-xs text-contentMuted mt-1">Finished in the last 30 days</p>
    </div>
  </div>

  {% set filter_links = [
    ('all', 'All', None),
    ('queued', 'Queued', 'queued'),
    ('running', 'Running', 'running'),
    ('completed', 'Completed', 'completed'),
    ('failed', 'Failed', 'failed')
  ] %}
  <div class="flex flex-wrap items-center gap-2">
    {% for slug, label, query in filter_links %}
      {% set active = (current_status or 'all') == slug %}
      <a href="/dashboard/jobs{{ '' if not query else '?status=' ~ query }}"
         class="inline-flex items-center rounded-full px-4 py-1.5 text-sm border {{ 'bg-primary/20 border-primary text-primary' if active else 'border-border text-contentMuted hover:border-border/80' }}">
        {{ label }}
      </a>
    {% endfor %}
  </div>

  <div id="jobs-list" class="space-y-3">
    {% from 'components/elements/button.html' import button %}
    {% from 'components/elements/badge.html' import badge %}
    {% for job in jobs %}
      <article class="surface rounded-lg p-4 space-y-3">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
          <div class="space-y-1">
            <p class="font-mono text-xs text-contentMuted break-words">{{ job.id }}</p>
            <p class="text-sm font-semibold text-content">{{ job.kind }}</p>
            <p class="text-xs text-contentMuted">Created {{ job.created_at }}</p>
          </div>
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
            {{ badge(job.status_label, status=job.status) }}
            <a href="/dashboard/jobs/{{ job.id }}" class="text-sm text-primary hover:text-primary/80">View</a>
          </div>
        </div>
        <div class="grid gap-3 text-sm text-contentMuted sm:grid-cols-2">
          <div class="space-y-1">
            <p class="text-xs uppercase tracking-wide">Document</p>
            <p class="font-mono break-all">{{ job.document_id or '—' }}</p>
          </div>
          <div class="space-y-1">
            <p class="text-xs uppercase tracking-wide">Owner</p>
            <p>{{ job.user or '—' }}</p>
          </div>
        </div>
        <div class="flex flex-col gap-2 sm:flex-row sm:justify-end">
          {{ button(
            'Retry',
            variant='ghost',
            with_spinner=True,
            extra_classes='text-contentMuted hover:text-content w-full sm:w-auto',
            attrs='hx-post="/dashboard/jobs/' ~ job.id ~ '/retry" hx-headers="{&quot;X-CSRF-Token&quot;:&quot;{{ csrf_token }}&quot;}" hx-swap="none" hx-on:htmx:responseError="window.dispatchEvent(new CustomEvent(\'toast\',{detail:{type:\'error\',text:\'Retry failed\'}}))"'
          ) }}
          {{ button(
            'Cancel',
            variant='ghost',
            with_spinner=True,
            extra_classes='text-destructive hover:text-destructive/80 w-full sm:w-auto',
            attrs='hx-delete="/dashboard/jobs/' ~ job.id ~ '" hx-headers="{&quot;X-CSRF-Token&quot;:&quot;{{ csrf_token }}&quot;}" hx-swap="none" hx-on:htmx:responseError="window.dispatchEvent(new CustomEvent(\'toast\',{detail:{type:\'error\',text:\'Cancel failed\'}}))"'
          ) }}
        </div>
      </article>
    {% else %}
      <div class="surface rounded-lg p-6 text-center text-sm text-contentMuted">No jobs found</div>
    {% endfor %}
  </div>
{% endcall %}
