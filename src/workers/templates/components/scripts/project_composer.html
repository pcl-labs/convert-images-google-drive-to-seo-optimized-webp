<script>
  function projectComposer(config){
    return {
      mode: 'text',
      busy: false,
      error: null,
      csrfToken: config?.csrfToken || '',
      youtubeConnected: !!config?.youtubeConnected,
      schemaChoices: Array.isArray(config?.schemaChoices) ? config.schemaChoices : [],
      form: {
        text: '',
        youtube: '',
        instructions: '',
        content_type: (Array.isArray(config?.schemaChoices) && config.schemaChoices.length) ? config.schemaChoices[0][0] : 'https://schema.org/BlogPosting'
      },
      init(){
        if(this.schemaChoices.length && !this.form.content_type){
          this.form.content_type = this.schemaChoices[0][0];
        }
      },
      setMode(mode){
        this.mode = mode;
        this.error = null;
      },
      validate(){
        if(this.mode === 'text' && !this.form.text.trim()){
          this.error = 'Paste some text to start a project.';
          return false;
        }
        if(this.mode === 'youtube'){
          if(!this.youtubeConnected){
            this.error = 'Connect your YouTube account to ingest videos.';
            return false;
          }
          if(!this.form.youtube.trim()){
            this.error = 'YouTube URL is required.';
            return false;
          }
        }
        return true;
      },
      endpoint(){
        return this.mode === 'text' ? '/api/v1/projects/text' : '/api/v1/projects';
      },
      payload(){
        if(this.mode === 'text'){
          return {
            text: this.form.text.trim(),
            title: null,
          };
        }
        return { youtube_url: this.form.youtube.trim() };
      },
      headers(){
        const headers = { 'Content-Type': 'application/json' };
        if(this.csrfToken){
          headers['X-CSRF-Token'] = this.csrfToken;
        }
        return headers;
      },
      async submit(){
        if(this.busy || !this.validate()){
          return;
        }
        this.busy = true;
        this.error = null;
        try {
          const response = await fetch(this.endpoint(), {
            method: 'POST',
            headers: this.headers(),
            credentials: 'same-origin',
            body: JSON.stringify(this.payload()),
          });
          const data = await response.json();
          if(!response.ok){
            const detail = (data && (data.detail || data.error)) || 'Failed to create project.';
            throw new Error(detail);
          }
          const projectId = data?.project?.project_id || data?.project?.id;
          if(projectId){
            window.location.assign(`/dashboard/projects/${projectId}`);
            return;
          }
          this.error = 'Project created but missing identifier.';
        } catch (err) {
          this.error = err && err.message ? err.message : 'Failed to create project.';
        } finally {
          this.busy = false;
        }
      },
    };
  }
</script>
