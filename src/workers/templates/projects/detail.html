{% extends "base.html" %}
{% from 'components/layout/page.html' import page_container %}

{% block content %}
<div class="flex flex-col lg:flex-row min-h-[calc(100vh-3.5rem)]">
  <main class="flex-1 min-w-0 px-4 py-6 lg:px-8 space-y-4">
    {% call page_container() %}
      <header class="flex items-center justify-between gap-4 mb-4">
        <div class="space-y-1">
          <p class="text-[11px] font-medium uppercase tracking-wide text-contentMuted">Project</p>
          <h1 class="text-2xl font-semibold text-content break-words">
            {{ project.youtube_url or project.project_id }}
          </h1>
          <p class="text-xs text-contentMuted flex items-center gap-2">
            <span>Status:</span>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full border border-border bg-surface text-[11px] font-medium">
              {{ project.status or 'pending' }}
            </span>
          </p>
        </div>
        <div class="flex items-center gap-2">
          <button
            id="generate-blog-btn"
            type="button"
            class="btn-primary text-xs"
          >
            Generate
          </button>
          <a
            href="/api/v1/projects/{{ project.project_id }}/blog/export"
            class="btn-secondary text-xs"
          >
            Export MDX
          </a>
        </div>
      </header>

      {% include "projects/_sections.html" %}
    {% endcall %}
  </main>

  <aside class="w-full lg:w-80 xl:w-96 border-t lg:border-t-0 lg:border-l border-border bg-surface px-4 py-4 space-y-6">
    {% include "projects/_seo_panel.html" %}
    {% include "projects/_activity_panel.html" %}
  </aside>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  function dispatchToast(type, text){
    try {
      window.dispatchEvent(new CustomEvent('toast', { detail: { type: type, text: text } }));
    } catch (_) {}
  }

  function setupGenerateBlogButton(){
    const btn = document.getElementById('generate-blog-btn');
    if(!btn) return;
    const projectId = {{ project.project_id | tojson }};

    btn.addEventListener('click', async () => {
      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = 'Generating…';
      try {
        const res = await fetch(`/api/v1/projects/${projectId}/blog/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        });
        if(!res.ok){
          dispatchToast('error', 'Failed to start blog generation.');
          return;
        }
        dispatchToast('success', 'Blog generation started. This may take a moment.');
      } catch (err) {
        dispatchToast('error', 'Unexpected error starting blog generation.');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });
  }

  function setupSectionEditing(){
    const root = document.getElementById('project-sections');
    if(!root) return;
    const projectId = root.dataset.projectId;
    if(!projectId) return;
    const tabs = root.querySelectorAll('[data-sections-tab]');
    const panels = root.querySelectorAll('[data-sections-panel]');
    const detailIndex = root.querySelector('#section-detail-index');
    const detailTitle = root.querySelector('#section-detail-title');
    const detailMeta = root.querySelector('#section-detail-meta');
    const detailBody = root.querySelector('#section-detail-body');
    const askModal = document.getElementById('section-ask-changes-modal');
    const askTextarea = document.getElementById('ask-changes-textarea');
    const askSectionLabel = document.getElementById('ask-changes-section-label');
    let currentSectionId = null;

    function switchTab(name){
      tabs.forEach((tab) => {
        const key = tab.getAttribute('data-sections-tab');
        const isActive = key === name;
        tab.classList.toggle('text-primary', isActive);
        tab.classList.toggle('border-primary', isActive);
        tab.classList.toggle('text-contentMuted', !isActive);
        tab.classList.toggle('border-transparent', !isActive);
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      panels.forEach((panel) => {
        const key = panel.getAttribute('data-sections-panel');
        panel.classList.toggle('hidden', key !== name);
      });
    }

    function updateDetailFromRow(row){
      if(!row || !detailIndex || !detailTitle || !detailMeta || !detailBody){
        return;
      }
      const sectionId = row.getAttribute('data-section-id');
      const index = Number(row.getAttribute('data-section-index') || '0');
      const title = row.getAttribute('data-section-title') || 'Untitled section';
      const words = row.getAttribute('data-section-words') || '0';
      const preview = row.getAttribute('data-section-preview') || 'No content yet.';
      currentSectionId = sectionId;
      detailIndex.textContent = `Section ${index + 1}`;
      detailTitle.textContent = title;
      detailMeta.textContent = `${words} words`;
      detailBody.textContent = preview;
    }

    function openAskModal(){
      if(!askModal || !currentSectionId){
        dispatchToast('error', 'Select a section first.');
        return;
      }
      const activeRow = root.querySelector(
        `button[data-action="select-section"][data-section-id="${CSS.escape(currentSectionId)}"]`
      );
      const index = activeRow ? Number(activeRow.getAttribute('data-section-index') || '0') : 0;
      const title = activeRow ? (activeRow.getAttribute('data-section-title') || 'Untitled section') : 'Section';
      if(askSectionLabel){
        askSectionLabel.textContent = `Section ${index + 1} · ${title}`;
      }
      if(askTextarea){
        askTextarea.value = '';
        askTextarea.focus();
      }
      askModal.classList.remove('hidden');
    }

    function closeAskModal(){
      if(!askModal) return;
      askModal.classList.add('hidden');
    }

    root.addEventListener('click', async (event) => {
      const target = event.target;
      if(!(target instanceof HTMLElement)) return;

      // Tabs: Summary / Full diff
      const tab = target.closest('button[data-sections-tab]');
      if(tab){
        const key = tab.getAttribute('data-sections-tab') || 'summary';
        switchTab(key);
        return;
      }

      const action = target.dataset.action;
      if(!action) return;

      if(action === 'select-section'){
        const row = target.closest('button[data-section-id]');
        if(!row) return;
        updateDetailFromRow(row);
        switchTab('detail');
        return;
      }

      if(action === 'back-to-summary'){
        switchTab('summary');
        return;
      }

      if(action === 'open-ask-changes'){
        openAskModal();
        return;
      }

      if(action === 'close-ask-changes'){
        closeAskModal();
        return;
      }

      if(action === 'submit-ask-changes'){
        if(!currentSectionId || !askTextarea) return;
        const instructions = (askTextarea.value || '').trim();
        if(!instructions){
          dispatchToast('error', 'Please describe the changes you want.');
          return;
        }
        const btn = target;
        btn.disabled = true;
        btn.textContent = 'Applying…';
        try {
          const res = await fetch(`/api/v1/projects/${projectId}/blog/sections/patch`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ section_id: currentSectionId, instructions }),
          });
          if(res.status === 409){
            dispatchToast('error', 'Blog has been updated since this section was loaded; please reload and retry.');
            return;
          }
          if(!res.ok){
            dispatchToast('error', 'Failed to apply changes to this section.');
            return;
          }
          const data = await res.json();
          const body = data && data.section && (data.section.body_mdx || data.section.body_html || '');
          if(typeof body === 'string'){
            let trimmed = body.trim();
            if(trimmed.length > 800){
              trimmed = trimmed.slice(0, 800) + '…';
            }
            // Update detail view
            if(detailBody){
              detailBody.textContent = trimmed || 'No content yet.';
            }
            // Update summary row preview
            const row = root.querySelector(
              `button[data-action="select-section"][data-section-id="${CSS.escape(currentSectionId)}"]`
            );
            if(row){
              const previewEl = row.querySelector('p.text-[11px].text-contentMuted');
              if(previewEl){
                previewEl.textContent = trimmed || 'No content yet.';
              }
              row.setAttribute('data-section-preview', trimmed || 'No content yet.');
            }
          }
          dispatchToast('success', 'Section updated.');
          closeAskModal();
        } catch (err) {
          dispatchToast('error', 'Unexpected error updating section.');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Apply with AI';
        }
      }
    });

    // Ensure initial detail view has sensible state based on first row, if any.
    const firstRow = root.querySelector('button[data-action="select-section"]');
    if(firstRow){
      updateDetailFromRow(firstRow);
    }
  }

  function setupActivityRefresh(){
    const root = document.getElementById('project-activity');
    if(!root) return;
    const projectId = root.dataset.projectId;
    if(!projectId) return;

    root.addEventListener('click', async (event) => {
      const target = event.target;
      if(!(target instanceof HTMLElement)) return;
      const action = target.dataset.action;
      if(action !== 'refresh-activity') return;

      const btn = target;
      btn.disabled = true;
      btn.textContent = 'Refreshing…';
      try {
        const res = await fetch(`/api/v1/projects/${projectId}/activity`, {
          method: 'GET',
          credentials: 'same-origin',
        });
        if(!res.ok){
          dispatchToast('error', 'Failed to refresh activity.');
          return;
        }
        const data = await res.json();
        const items = (data && data.items) || [];
        const listRoot = root.querySelector('[data-activity-list]');
        if(!listRoot) return;
        listRoot.innerHTML = '';
        if(!items.length){
          listRoot.innerHTML = '<p class="text-xs text-contentMuted">No recent activity for this project yet.</p>';
          return;
        }
        const ol = document.createElement('ol');
        ol.className = 'space-y-2 text-sm';
        items.forEach((item) => {
          const li = document.createElement('li');
          li.className = 'rounded-md border border-border bg-surface/60 p-2 flex gap-2';
          const dot = document.createElement('div');
          dot.className = 'mt-1 h-2 w-2 rounded-full ' + (
            item.status === 'failed' || item.status === 'error'
              ? 'bg-destructive'
              : item.status === 'completed'
                ? 'bg-accent'
                : 'bg-border'
          );
          const body = document.createElement('div');
          body.className = 'flex-1 min-w-0';
          const header = document.createElement('div');
          header.className = 'flex items-center justify-between gap-2';
          const kind = document.createElement('span');
          kind.className = 'text-[11px] font-medium uppercase text-contentMuted';
          const kindLabel = (item.kind || '').toString();
          const eventType = (item.event_type || '').toString();
          kind.textContent = eventType ? `${kindLabel} · ${eventType}` : kindLabel;
          const ts = document.createElement('span');
          ts.className = 'text-[11px] text-contentMuted';
          ts.textContent = item.created_at || '';
          header.appendChild(kind);
          header.appendChild(ts);
          const label = document.createElement('p');
          label.className = 'text-xs text-content font-medium';
          label.textContent = item.label || '';
          body.appendChild(header);
          body.appendChild(label);
          if(item.description){
            const desc = document.createElement('p');
            desc.className = 'text-xs text-contentMuted truncate';
            desc.textContent = item.description;
            body.appendChild(desc);
          }
          li.appendChild(dot);
          li.appendChild(body);
          ol.appendChild(li);
        });
        listRoot.appendChild(ol);
      } catch (err) {
        dispatchToast('error', 'Unexpected error refreshing activity.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Refresh';
      }
    });
  }

  function setupSeoPanel(){
    const panel = document.getElementById('project-seo-panel');
    if(!panel) return;
    const projectId = panel.dataset.projectId;
    if(!projectId) return;
    const refreshBtn = panel.querySelector('[data-action="refresh-seo"]');
    const loadingEl = panel.querySelector('[data-seo-loading]');
    const contentEl = panel.querySelector('[data-seo-content]');
    const errorEl = panel.querySelector('[data-seo-error]');
    const summaryEl = panel.querySelector('[data-seo-summary]');
    const titleEl = panel.querySelector('[data-seo-title]');
    const descriptionEl = panel.querySelector('[data-seo-description]');
    const analyzedAtEl = panel.querySelector('[data-seo-analyzed-at]');
    const cacheBadge = panel.querySelector('[data-seo-cache-badge]');
    const wordCountEl = panel.querySelector('[data-seo-word-count]');
    const readingTimeEl = panel.querySelector('[data-seo-reading-time]');
    const schemaEl = panel.querySelector('[data-seo-schema]');
    const keywordsWrap = panel.querySelector('[data-seo-keywords]');
    const scoresWrap = panel.querySelector('[data-seo-scores]');
    const suggestionsWrap = panel.querySelector('[data-seo-suggestions]');

    const levelColorMap = {
      good: 'bg-accent',
      average: 'bg-primary',
      poor: 'bg-destructive'
    };

    function setState(state){
      if(state === 'loading'){
        loadingEl?.classList.remove('hidden');
        contentEl?.classList.add('hidden');
        if(errorEl){
          errorEl.classList.add('hidden');
          errorEl.textContent = '';
        }
      } else if(state === 'error'){
        loadingEl?.classList.add('hidden');
        contentEl?.classList.add('hidden');
      } else {
        loadingEl?.classList.add('hidden');
        contentEl?.classList.remove('hidden');
        if(errorEl){
          errorEl.classList.add('hidden');
          errorEl.textContent = '';
        }
      }
    }

    function formatDateTime(value){
      if(!value) return 'Never analyzed';
      try {
        const date = new Date(value);
        if(Number.isNaN(date.getTime())){
          return value;
        }
        return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      } catch (err) {
        return value;
      }
    }

    function renderKeywords(keywords){
      if(!keywordsWrap) return;
      keywordsWrap.innerHTML = '';
      if(!Array.isArray(keywords) || !keywords.length){
        const empty = document.createElement('p');
        empty.className = 'text-[11px] text-contentMuted';
        empty.textContent = 'No keyword targets detected.';
        keywordsWrap.appendChild(empty);
        return;
      }
      keywords.forEach((keyword) => {
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center rounded-full border border-border px-2 py-0.5 text-[10px] text-content';
        chip.textContent = keyword;
        keywordsWrap.appendChild(chip);
      });
    }

    function renderScores(scores){
      if(!scoresWrap) return;
      scoresWrap.innerHTML = '';
      if(!Array.isArray(scores) || !scores.length){
        scoresWrap.innerHTML = '<p class="text-xs text-contentMuted">Scores will appear after analysis.</p>';
        return;
      }
      scores.forEach((score) => {
        const container = document.createElement('div');
        container.className = 'space-y-1 rounded-xl border border-border px-3 py-2 bg-surface/60';
        const header = document.createElement('div');
        header.className = 'flex items-center justify-between text-xs font-medium';
        const label = document.createElement('span');
        label.textContent = score.label || score.name;
        const value = document.createElement('span');
        value.textContent = `${Math.round(score.score || 0)} / 100`;
        header.appendChild(label);
        header.appendChild(value);

        const bar = document.createElement('div');
        bar.className = 'h-2 rounded-full bg-border/70 overflow-hidden';
        const fill = document.createElement('div');
        const levelKey = (score.level || '').toLowerCase();
        const colorClass = levelColorMap[levelKey] || 'bg-primary';
        fill.className = `h-2 rounded-full ${colorClass}`;
        fill.style.width = `${Math.max(0, Math.min(100, Number(score.score) || 0))}%`;
        bar.appendChild(fill);

        container.appendChild(header);
        container.appendChild(bar);
        if(score.details){
          const detail = document.createElement('p');
          detail.className = 'text-[11px] text-contentMuted';
          detail.textContent = score.details;
          container.appendChild(detail);
        }
        scoresWrap.appendChild(container);
      });
    }

    function renderSuggestions(suggestions){
      if(!suggestionsWrap) return;
      suggestionsWrap.innerHTML = '';
      if(!Array.isArray(suggestions) || !suggestions.length){
        suggestionsWrap.innerHTML = '<p class="text-xs text-contentMuted">All checks passing—great work.</p>';
        return;
      }
      suggestions.forEach((item) => {
        const row = document.createElement('div');
        row.className = 'rounded-lg border border-border/70 bg-surface px-3 py-2';
        const title = document.createElement('p');
        title.className = 'text-xs font-semibold text-content';
        title.textContent = item.title || item.id;
        const summary = document.createElement('p');
        summary.className = 'text-[11px] text-contentMuted mt-0.5';
        summary.textContent = item.summary || '';
        row.appendChild(title);
        row.appendChild(summary);
        suggestionsWrap.appendChild(row);
      });
    }

    function renderAnalysis(analysis){
      if(!analysis){
        setState('loading');
        return;
      }
      setState('ready');
      if(summaryEl){
        summaryEl.textContent = analysis.seo && analysis.seo.description
          ? analysis.seo.description
          : 'Latest SEO snapshot for this draft.';
      }
      if(titleEl){
        titleEl.textContent = (analysis.seo && analysis.seo.title) || 'Untitled draft';
      }
      if(descriptionEl){
        descriptionEl.textContent = (analysis.seo && analysis.seo.slug) || 'No slug yet.';
      }
      if(analyzedAtEl){
        analyzedAtEl.textContent = `Analyzed ${formatDateTime(analysis.analyzed_at || analysis.generated_at)}`;
      }
      if(cacheBadge){
        if(analysis.is_cached){
          cacheBadge.classList.remove('hidden');
        } else {
          cacheBadge.classList.add('hidden');
        }
      }
      if(wordCountEl){
        wordCountEl.textContent = (analysis.word_count || 0).toLocaleString();
      }
      if(readingTimeEl){
        const minutes = Math.max(1, Math.round((analysis.reading_time_seconds || 0) / 60)) || '—';
        readingTimeEl.textContent = minutes;
      }
      if(schemaEl){
        schemaEl.textContent = analysis.schema_type || 'BlogPosting';
      }
      renderKeywords(analysis.seo ? analysis.seo.keywords : []);
      renderScores(analysis.scores || []);
      renderSuggestions(analysis.suggestions || []);
    }

    async function fetchAnalysis(showToast = false){
      if(refreshBtn){
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Analyzing…';
      }
      setState('loading');
      try {
        const res = await fetch(`/api/v1/projects/${projectId}/seo/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        });
        if(!res.ok){
          throw new Error('Request failed');
        }
        const data = await res.json();
        renderAnalysis(data);
        if(showToast){
          dispatchToast('success', 'SEO analysis updated.');
        }
      } catch (err) {
        if(errorEl){
          errorEl.textContent = 'Failed to load SEO analysis. Try again in a moment.';
          errorEl.classList.remove('hidden');
        }
        setState('error');
        if(showToast){
          dispatchToast('error', 'Unable to analyze SEO right now.');
        }
      } finally {
        if(refreshBtn){
          refreshBtn.disabled = false;
          refreshBtn.textContent = 'Analyze';
        }
      }
    }

    const initialValue = panel.dataset.initialAnalysis;
    if(initialValue && initialValue !== 'null'){
      try {
        const parsed = JSON.parse(initialValue);
        renderAnalysis(parsed);
        loadingEl?.classList.add('hidden');
        contentEl?.classList.remove('hidden');
      } catch (err) {
        fetchAnalysis(false);
      }
    } else {
      fetchAnalysis(false);
    }

    panel.addEventListener('click', (event) => {
      const target = event.target;
      if(!(target instanceof HTMLElement)) return;
      if(target.dataset.action === 'refresh-seo'){
        fetchAnalysis(true);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function(){
    setupSectionEditing();
    setupActivityRefresh();
    setupGenerateBlogButton();
    setupSeoPanel();
  });
})();
</script>
{% endblock %}
